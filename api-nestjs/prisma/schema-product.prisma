// ============================================================================
// PRODUCT CORE DOMAIN SCHEMA
// ============================================================================
// Enterprise-grade product system for marketplace backend
// Supports lifecycle management, ownership, moderation, and variant preparation

// ============================================================================
// CORE PRODUCT MODEL
// ============================================================================

model Product {
  id          String   @id @default(cuid()) @map("id")
  
  // Basic Information
  name        String   @map("name")
  slug        String   @unique @map("slug")
  description String?  @map("description")
  shortDescription String? @map("short_description")
  
  // Relationships (Required)
  categoryId  String   @map("category_id")
  brandId     String   @map("brand_id")
  sellerId    String   @map("seller_id")
  
  // Product Lifecycle
  status      ProductStatus @default(DRAFT) @map("status")
  visibility  ProductVisibility @default(PRIVATE) @map("visibility")
  
  // Moderation & Approval
  moderationStatus ProductModerationStatus @default(PENDING) @map("moderation_status")
  moderationNotes  String? @map("moderation_notes")
  moderatedBy      String? @map("moderated_by")
  moderatedAt      DateTime? @map("moderated_at")
  
  // Publishing Control
  publishedAt      DateTime? @map("published_at")
  scheduledPublishAt DateTime? @map("scheduled_publish_at")
  
  // SEO & Marketing
  seoTitle         String? @map("seo_title")
  seoDescription   String? @map("seo_description")
  seoKeywords      String[] @map("seo_keywords")
  metaData         Json? @map("meta_data")
  
  // Media
  images           String[] @map("images")           // Array of image URLs
  videos           String[] @map("videos")           // Array of video URLs
  documents        String[] @map("documents")        // Array of document URLs
  
  // Organization
  tags             String[] @map("tags")
  displayOrder     Int @default(0) @map("display_order")
  isFeatured       Boolean @default(false) @map("is_featured")
  
  // Variant Configuration
  hasVariants      Boolean @default(false) @map("has_variants")
  variantAttributes String[] @map("variant_attributes") // Attribute IDs that drive variants
  
  // Versioning & Concurrency
  version          Int @default(1) @map("version")
  
  // System Fields
  createdBy        String    @map("created_by")
  updatedBy        String?   @map("updated_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  deletedBy        String?   @map("deleted_by")
  
  // Relationships
  category         Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  brand            Brand @relation(fields: [brandId], references: [id], onDelete: Restrict)
  seller           User @relation("SellerProducts", fields: [sellerId], references: [id], onDelete: Restrict)
  
  attributeValues  ProductAttributeValue[]
  variants         ProductVariant[]
  auditLogs        ProductAuditLog[]
  reviews          ProductReview[]
  
  // Indexes for Performance
  @@index([categoryId])
  @@index([brandId])
  @@index([sellerId])
  @@index([status])
  @@index([visibility])
  @@index([moderationStatus])
  @@index([publishedAt])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@index([slug])
  @@index([sellerId, status])
  @@index([categoryId, status, visibility])
  @@index([brandId, status, visibility])
  @@map("products")
}

// ============================================================================
// PRODUCT ATTRIBUTE VALUES
// ============================================================================

model ProductAttributeValue {
  id          String   @id @default(cuid()) @map("id")
  productId   String   @map("product_id")
  attributeId String   @map("attribute_id")
  
  // Value Storage (polymorphic based on attribute data type)
  stringValue   String?   @map("string_value")
  numberValue   Decimal?  @map("number_value") @db.Decimal(15, 4)
  booleanValue  Boolean?  @map("boolean_value")
  dateValue     DateTime? @map("date_value")
  jsonValue     Json?     @map("json_value")
  optionId      String?   @map("option_id")    // For ENUM/SELECT types
  
  // Localization
  locale        String    @default("en") @map("locale")
  
  // Inheritance Tracking
  inheritedFrom String?   @map("inherited_from") // Category ID if inherited
  isOverridden  Boolean   @default(false) @map("is_overridden")
  
  // System Fields
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relationships
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute     Attribute @relation(fields: [attributeId], references: [id], onDelete: Restrict)
  option        AttributeOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)
  
  // Constraints
  @@unique([productId, attributeId, locale])
  @@index([productId])
  @@index([attributeId])
  @@index([stringValue])
  @@index([numberValue])
  @@index([booleanValue])
  @@index([dateValue])
  @@index([optionId])
  @@map("product_attribute_values")
}

// ============================================================================
// PRODUCT VARIANTS (Placeholder for future implementation)
// ============================================================================

model ProductVariant {
  id          String   @id @default(cuid()) @map("id")
  productId   String   @map("product_id")
  
  // Variant Identity
  sku         String   @unique @map("sku")
  name        String?  @map("name")           // Optional variant name
  
  // Variant Attributes (combination that defines this variant)
  attributeValues Json @map("attribute_values") // Stored as JSON for now
  
  // Status
  status      ProductVariantStatus @default(ACTIVE) @map("status")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relationships
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([productId])
  @@index([status])
  @@map("product_variants")
}

// ============================================================================
// PRODUCT AUDIT LOGGING
// ============================================================================

model ProductAuditLog {
  id          String   @id @default(cuid()) @map("id")
  productId   String   @map("product_id")
  
  // Action Details
  action      String   @map("action")        // CREATE, UPDATE, DELETE, PUBLISH, etc.
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  changes     Json?    @map("changes")
  
  // Context
  userId      String   @map("user_id")
  userRole    String   @map("user_role")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  reason      String?  @map("reason")
  metadata    Json?    @map("metadata")
  batchId     String?  @map("batch_id")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relationships
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([productId])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@index([batchId])
  @@map("product_audit_logs")
}

// ============================================================================
// PRODUCT REVIEWS (Placeholder for future implementation)
// ============================================================================

model ProductReview {
  id          String   @id @default(cuid()) @map("id")
  productId   String   @map("product_id")
  userId      String   @map("user_id")
  
  // Review Content
  rating      Int      @map("rating")        // 1-5 stars
  title       String?  @map("title")
  content     String?  @map("content")
  
  // Status
  status      ReviewStatus @default(PENDING) @map("status")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relationships
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([productId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@map("product_reviews")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ProductStatus {
  DRAFT       // Being created/edited by seller
  SUBMITTED   // Submitted for review
  APPROVED    // Approved by admin/moderator
  PUBLISHED   // Live and visible to customers
  REJECTED    // Rejected during review
  SUSPENDED   // Temporarily suspended
  ARCHIVED    // Permanently archived
  
  @@map("product_status")
}

enum ProductVisibility {
  PRIVATE     // Only visible to seller and admins
  INTERNAL    // Visible to sellers and admins
  PUBLIC      // Visible to everyone (when published)
  
  @@map("product_visibility")
}

enum ProductModerationStatus {
  PENDING     // Awaiting moderation
  APPROVED    // Approved by moderator
  REJECTED    // Rejected by moderator
  FLAGGED     // Flagged for review
  REVIEWING   // Currently under review
  
  @@map("product_moderation_status")
}

enum ProductVariantStatus {
  ACTIVE      // Available for sale
  INACTIVE    // Not available for sale
  ARCHIVED    // Permanently archived
  
  @@map("product_variant_status")
}

enum ReviewStatus {
  PENDING     // Awaiting moderation
  APPROVED    // Approved and visible
  REJECTED    // Rejected and hidden
  FLAGGED     // Flagged for review
  
  @@map("review_status")
}

// ============================================================================
// ADDITIONAL INDEXES FOR PERFORMANCE
// ============================================================================

// Composite indexes for common query patterns
// @@index([sellerId, status, updatedAt])     // Seller's products by status
// @@index([categoryId, status, publishedAt]) // Category products by publish date
// @@index([brandId, status, isFeatured])     // Brand featured products
// @@index([status, visibility, publishedAt]) // Public product listings
// @@index([moderationStatus, createdAt])     // Moderation queue
// @@index([isFeatured, status, displayOrder]) // Featured product ordering