// ================================
// REFUND SYSTEM SCHEMA (RAZORPAY)
// ================================

model Refund {
  id          String   @id @default(cuid())
  
  // Refund Identification
  refundId    String   @unique // Our internal refund ID
  refundNumber String  @unique // Human-readable refund number (REF-2024-001)
  
  // Order & Payment Association
  orderId     String
  paymentIntentId String?
  paymentTransactionId String?
  
  // Refund Type & Classification
  refundType  String   // FULL, PARTIAL, ITEM_LEVEL
  refundCategory String // CUSTOMER_REQUEST, MERCHANT_INITIATED, SYSTEM_INITIATED, DISPUTE_RESOLUTION
  
  // Amount Details (in paise/cents)
  requestedAmount Int    // Originally requested refund amount
  approvedAmount  Int    // Final approved refund amount
  processedAmount Int?   // Actually processed amount (may differ due to fees)
  currency        String @default("INR")
  
  // Refund Reason & Details
  reason          String // CUSTOMER_REQUEST, DEFECTIVE_PRODUCT, WRONG_ITEM, CANCELLATION, etc.
  reasonCode      String // Standardized reason code
  description     String?
  customerNotes   String?
  merchantNotes   String?
  
  // Status & Lifecycle
  status          String @default("PENDING") // PENDING, APPROVED, REJECTED, PROCESSING, COMPLETED, FAILED, CANCELLED
  
  // Approval Workflow
  requiresApproval Boolean @default(false)
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  
  // Gateway Integration
  gatewayProvider String @default("RAZORPAY")
  gatewayRefundId String? // Razorpay refund ID
  gatewayResponse Json   @default("{}")
  
  // Processing Details
  processedAt     DateTime?
  completedAt     DateTime?
  failedAt        DateTime?
  
  // Failure Information
  failureCode     String?
  failureMessage  String?
  failureReason   String?
  
  // Retry Logic
  retryCount      Int    @default(0)
  maxRetries      Int    @default(3)
  nextRetryAt     DateTime?
  
  // Idempotency
  idempotencyKey  String @unique
  
  // Eligibility & Validation
  eligibilityChecked Boolean @default(false)
  eligibilityResult  Json?   // Detailed eligibility check results
  
  // Inventory Impact
  restockRequired Boolean @default(false)
  restockCompleted Boolean @default(false)
  restockJobId    String?
  
  // Financial Impact
  refundFees      Int    @default(0) // Gateway refund fees
  adjustmentAmount Int   @default(0) // Any adjustments applied
  
  // Metadata & Context
  metadata        Json   @default("{}")
  tags            String[] @default([])
  
  // Audit Trail
  auditTrail      Json   @default("[]") // Array of audit events
  
  // System Fields
  createdBy       String
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  order           Order              @relation(fields: [orderId], references: [id])
  paymentIntent   PaymentIntent?     @relation(fields: [paymentIntentId], references: [id])
  paymentTransaction PaymentTransaction? @relation(fields: [paymentTransactionId], references: [id])
  creator         User               @relation("RefundCreator", fields: [createdBy], references: [id])
  approver        User?              @relation("RefundApprover", fields: [approvedBy], references: [id])
  rejecter        User?              @relation("RefundRejecter", fields: [rejectedBy], references: [id])
  
  items           RefundItem[]
  ledgerEntries   RefundLedgerEntry[]
  auditLogs       RefundAuditLog[]
  webhooks        RefundWebhook[]
  jobs            RefundJob[]
  
  // Indexes
  @@index([orderId])
  @@index([paymentIntentId])
  @@index([paymentTransactionId])
  @@index([status])
  @@index([refundType])
  @@index([gatewayRefundId])
  @@index([idempotencyKey])
  @@index([createdBy])
  @@index([approvedBy])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@index([orderId, status])
  @@index([status, createdAt])
  
  @@map("refunds")
}

model RefundItem {
  id          String   @id @default(cuid())
  
  // Refund Association
  refundId    String
  
  // Order Item Association
  orderItemId String
  
  // Item Details (Snapshot)
  variantId   String
  productId   String
  sellerId    String
  sku         String
  productName String
  variantName String?
  
  // Refund Quantity & Amount
  requestedQuantity Int
  approvedQuantity  Int
  unitPrice         Int    // Price per unit in paise/cents
  totalAmount       Int    // Total refund amount for this item
  
  // Item-specific Reason
  reason            String?
  reasonCode        String?
  condition         String? // NEW, USED, DAMAGED, DEFECTIVE
  
  // Inventory Impact
  restockQuantity   Int    @default(0)
  restockStatus     String @default("PENDING") // PENDING, COMPLETED, FAILED, NOT_REQUIRED
  
  // Item Snapshot (Immutable)
  itemSnapshot      Json   // Complete item data at refund time
  
  // System Fields
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  refund            Refund     @relation(fields: [refundId], references: [id], onDelete: Cascade)
  orderItem         OrderItem  @relation(fields: [orderItemId], references: [id])
  variant           ProductVariant @relation(fields: [variantId], references: [id])
  product           Product    @relation(fields: [productId], references: [id])
  seller            User       @relation(fields: [sellerId], references: [id])
  
  // Indexes
  @@index([refundId])
  @@index([orderItemId])
  @@index([variantId])
  @@index([sellerId])
  @@index([restockStatus])
  
  @@map("refund_items")
}

model RefundLedgerEntry {
  id          String   @id @default(cuid())
  
  // Refund Association
  refundId    String
  
  // Ledger Entry Details
  entryType   String   // REFUND_INITIATED, REFUND_PROCESSED, REFUND_COMPLETED, REFUND_FAILED, FEE_DEDUCTED
  amount      Int      // Amount in paise/cents (can be negative for debits)
  currency    String   @default("INR")
  
  // Account Information
  accountType String   // CUSTOMER, MERCHANT, PLATFORM, GATEWAY
  accountId   String?  // Account identifier
  
  // Transaction Details
  description String
  reference   String?  // External reference (gateway transaction ID, etc.)
  
  // Balances (Running totals)
  runningBalance Int?
  
  // Metadata
  metadata    Json     @default("{}")
  
  // System Fields
  createdBy   String
  createdAt   DateTime @default(now())
  
  // Relations
  refund      Refund   @relation(fields: [refundId], references: [id], onDelete: Cascade)
  creator     User     @relation(fields: [createdBy], references: [id])
  
  // Indexes
  @@index([refundId])
  @@index([entryType])
  @@index([accountType])
  @@index([createdAt])
  @@index([refundId, createdAt])
  
  @@map("refund_ledger_entries")
}

model RefundAuditLog {
  id          String   @id @default(cuid())
  
  // Refund Association
  refundId    String
  
  // Audit Details
  action      String   // CREATE, UPDATE, APPROVE, REJECT, PROCESS, COMPLETE, FAIL, RETRY
  userId      String
  
  // State Changes
  oldValues   Json?
  newValues   Json?
  
  // Context
  reason      String?
  metadata    Json     @default("{}")
  
  // IP & User Agent (for security)
  ipAddress   String?
  userAgent   String?
  
  // System Fields
  createdAt   DateTime @default(now())
  
  // Relations
  refund      Refund   @relation(fields: [refundId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])
  
  // Indexes
  @@index([refundId])
  @@index([refundId, createdAt])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  
  @@map("refund_audit_logs")
}

model RefundWebhook {
  id          String   @id @default(cuid())
  
  // Refund Association (Optional - some webhooks are global)
  refundId    String?
  
  // Webhook Details
  webhookId   String   @unique // External webhook ID
  eventType   String   // refund.processed, refund.failed, etc.
  
  // Gateway Information
  gatewayProvider String @default("RAZORPAY")
  
  // Processing Status
  status      String   @default("RECEIVED") // RECEIVED, PROCESSING, PROCESSED, FAILED, IGNORED
  
  // Signature Verification
  signature   String?
  verified    Boolean  @default(false)
  
  // Payload & Response
  payload     Json     // Raw webhook payload
  headers     Json     @default("{}")
  
  // Processing Details
  processedAt DateTime?
  errorMessage String?
  
  // Idempotency
  processed   Boolean  @default(false)
  
  // System Fields
  receivedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  refund      Refund?  @relation(fields: [refundId], references: [id])
  
  // Indexes
  @@index([refundId])
  @@index([webhookId])
  @@index([eventType])
  @@index([status])
  @@index([processed])
  @@index([receivedAt])
  
  @@map("refund_webhooks")
}

model RefundJob {
  id          String   @id @default(cuid())
  
  // Job Details
  type        String   // PROCESS_REFUND, RESTOCK_INVENTORY, SEND_NOTIFICATION, SYNC_GATEWAY
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING
  
  // Associated Entities
  refundId    String?
  orderId     String?
  
  // Job Configuration
  payload     Json     @default("{}")
  options     Json     @default("{}")
  
  // Retry Logic
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  nextRetryAt DateTime?
  
  // Results
  result      Json?
  errorMessage String?
  
  // System Fields
  createdBy   String
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  refund      Refund?  @relation(fields: [refundId], references: [id])
  order       Order?   @relation(fields: [orderId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])
  
  // Indexes
  @@index([type])
  @@index([status])
  @@index([refundId])
  @@index([nextRetryAt])
  @@index([createdAt])
  
  @@map("refund_jobs")
}

// Refund Policy Configuration
model RefundPolicy {
  id          String   @id @default(cuid())
  
  // Policy Details
  name        String
  description String?
  
  // Scope
  sellerId    String?  // Seller-specific policy (null for global)
  categoryId  String?  // Category-specific policy
  productId   String?  // Product-specific policy
  
  // Policy Rules
  isActive    Boolean  @default(true)
  
  // Time Limits
  refundWindowDays Int  @default(30) // Days from delivery/purchase
  
  // Refund Types Allowed
  allowFullRefund    Boolean @default(true)
  allowPartialRefund Boolean @default(true)
  allowItemRefund    Boolean @default(true)
  
  // Approval Requirements
  requiresApproval   Boolean @default(false)
  autoApprovalLimit  Int?    // Auto-approve refunds below this amount
  
  // Conditions
  conditions         Json    @default("{}") // Complex policy conditions
  
  // Fees & Deductions
  refundFeePercent   Decimal @db.Decimal(5, 2) @default(0)
  refundFeeFixed     Int     @default(0)
  restockingFee      Int     @default(0)
  
  // System Fields
  createdBy          String
  updatedBy          String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relations
  seller             User?    @relation(fields: [sellerId], references: [id])
  creator            User     @relation("RefundPolicyCreator", fields: [createdBy], references: [id])
  
  // Indexes
  @@index([sellerId])
  @@index([categoryId])
  @@index([productId])
  @@index([isActive])
  
  @@map("refund_policies")
}

// Refund Eligibility Cache
model RefundEligibility {
  id          String   @id @default(cuid())
  
  // Order & Item Association
  orderId     String
  orderItemId String?  // Null for order-level eligibility
  
  // Eligibility Results
  isEligible  Boolean
  reason      String?  // Reason if not eligible
  
  // Eligibility Details
  maxRefundAmount Int?
  refundWindowEnd DateTime?
  
  // Policy Applied
  policyId    String?
  policySnapshot Json? // Snapshot of policy at check time
  
  // Cache Details
  checkedAt   DateTime @default(now())
  expiresAt   DateTime // Cache expiry
  
  // System Fields
  createdAt   DateTime @default(now())
  
  // Relations
  order       Order    @relation(fields: [orderId], references: [id])
  orderItem   OrderItem? @relation(fields: [orderItemId], references: [id])
  policy      RefundPolicy? @relation(fields: [policyId], references: [id])
  
  // Indexes
  @@index([orderId])
  @@index([orderItemId])
  @@index([expiresAt])
  @@index([orderId, orderItemId])
  
  @@map("refund_eligibility_cache")
}

// Refund Statistics & Analytics
model RefundStatistics {
  id          String   @id @default(cuid())
  
  // Time Period
  periodType  String   // DAILY, WEEKLY, MONTHLY, YEARLY
  periodStart DateTime
  periodEnd   DateTime
  
  // Scope
  sellerId    String?  // Seller-specific stats (null for global)
  categoryId  String?  // Category-specific stats
  
  // Refund Metrics
  totalRefunds        Int @default(0)
  totalRefundAmount   Int @default(0)
  
  // Refund Types
  fullRefunds         Int @default(0)
  partialRefunds      Int @default(0)
  itemRefunds         Int @default(0)
  
  // Status Breakdown
  pendingRefunds      Int @default(0)
  approvedRefunds     Int @default(0)
  rejectedRefunds     Int @default(0)
  completedRefunds    Int @default(0)
  failedRefunds       Int @default(0)
  
  // Processing Metrics
  avgProcessingTime   Int? // Average processing time in minutes
  avgApprovalTime     Int? // Average approval time in minutes
  
  // Reason Analysis
  reasonBreakdown     Json @default("{}") // Refund reasons with counts
  
  // System Fields
  calculatedAt        DateTime @default(now())
  createdAt           DateTime @default(now())
  
  // Relations
  seller              User? @relation(fields: [sellerId], references: [id])
  
  // Indexes
  @@index([periodType, periodStart])
  @@index([sellerId])
  @@index([categoryId])
  @@index([periodStart, periodEnd])
  
  @@map("refund_statistics")
}