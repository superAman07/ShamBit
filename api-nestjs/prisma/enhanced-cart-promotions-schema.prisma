// Enhanced Cart & Promotions System - Prisma Schema Models
// Add these models to your existing schema.prisma file

// Enhanced Cart model with enterprise features
model Cart {
  id                   String               @id @default(cuid())
  userId               String?              // null for guest carts
  sessionId            String?              // for guest identification
  status               CartStatus           @default(ACTIVE)
  
  // Pricing fields with Decimal precision
  subtotal             Decimal              @default(0) @db.Decimal(10, 2)
  discountAmount       Decimal              @default(0) @db.Decimal(10, 2)
  taxAmount            Decimal              @default(0) @db.Decimal(10, 2)
  shippingAmount       Decimal              @default(0) @db.Decimal(10, 2)
  totalAmount          Decimal              @default(0) @db.Decimal(10, 2)
  
  // Promotion tracking
  appliedPromotions    String[]             @default([]) // Legacy field for backward compatibility
  availablePromotions  String[]             @default([]) // Cached eligible promotion IDs
  
  // Localization
  currency             String               @default("INR")
  locale               String               @default("en-IN")
  timezone             String               @default("Asia/Kolkata")
  
  // Lifecycle management
  expiresAt            DateTime?            // 24 hours for guests, 30 days for users
  lastActivityAt       DateTime             @default(now())
  convertedToOrderId   String?              // Order ID when converted
  
  // Optimistic locking
  version              Int                  @default(1)
  
  // Audit fields
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  // Relations
  user                 User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                CartItem[]
  appliedPromotionDetails AppliedPromotion[] @relation("CartPromotions")
  reservations         InventoryReservation[] @relation("CartReservations")
  auditLogs            CartAuditLog[]
  priceHistory         CartPriceHistory[]   @relation("CartPriceHistory")
  
  // Indexes for performance
  @@index([userId, status])
  @@index([sessionId, status])
  @@index([expiresAt])
  @@index([lastActivityAt])
  @@index([userId, sessionId, status])
  
  @@map("carts")
}

// Enhanced CartItem model with price tracking and reservations
model CartItem {
  id                   String               @id @default(cuid())
  cartId               String
  variantId            String
  sellerId             String
  
  // Quantity and pricing
  quantity             Int
  unitPrice            Decimal              @db.Decimal(10, 2) // Price when added
  currentUnitPrice     Decimal              @db.Decimal(10, 2) // Current price (may differ)
  totalPrice           Decimal              @db.Decimal(10, 2) // quantity * currentUnitPrice
  discountAmount       Decimal              @default(0) @db.Decimal(10, 2) // Item-level discounts
  
  // Availability and reservations
  isAvailable          Boolean              @default(true)
  availabilityReason   String?              // Reason if not available
  reservationId        String?              // Soft reservation ID
  reservationExpiresAt DateTime?            // When reservation expires
  
  // Tracking
  addedAt              DateTime             @default(now())
  lastCheckedAt        DateTime             @default(now()) // Last availability check
  
  // Snapshots for change detection
  variantSnapshot      Json                 @default("{}")
  pricingSnapshot      Json                 @default("{}")
  
  // Relations
  cart                 Cart                 @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant              ProductVariant       @relation(fields: [variantId], references: [id])
  seller               SellerProfile        @relation(fields: [sellerId], references: [id])
  appliedPromotions    AppliedPromotion[]   @relation("CartItemPromotions")
  priceHistory         CartPriceHistory[]
  
  // Constraints
  @@unique([cartId, variantId, sellerId])
  @@index([variantId])
  @@index([sellerId])
  @@index([reservationId])
  @@index([cartId, variantId, sellerId])
  
  @@map("cart_items")
}

// Applied promotions with detailed tracking
model AppliedPromotion {
  id                   String               @id @default(cuid())
  promotionId          String
  promotionCode        String
  promotionName        String
  
  // Application context
  cartId               String?
  cartItemId           String?              // For item-specific promotions
  orderId              String?              // When converted to order
  
  // Discount details
  discountType         PromotionType
  discountValue        Decimal              @db.Decimal(10, 2)
  discountAmount       Decimal              @db.Decimal(10, 2) // Calculated discount
  maxDiscountAmount    Decimal?             @db.Decimal(10, 2)
  
  // Metadata
  priority             Int                  @default(0) // For stacking order
  eligibilitySnapshot  Json                 @default("{}") // Snapshot of eligibility criteria
  appliedAt            DateTime             @default(now())
  appliedBy            String?              // User ID or 'SYSTEM'
  
  // Relations
  promotion            Promotion            @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  cart                 Cart?                @relation("CartPromotions", fields: [cartId], references: [id], onDelete: Cascade)
  cartItem             CartItem?            @relation("CartItemPromotions", fields: [cartItemId], references: [id], onDelete: Cascade)
  order                Order?               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([cartId])
  @@index([promotionId])
  @@index([orderId])
  @@index([appliedAt])
  
  @@map("applied_promotions")
}

// Enhanced inventory reservation system
model InventoryReservation {
  id                      String               @id @default(cuid())
  variantId               String
  quantity                Int
  
  // Reference to what created this reservation
  referenceType           ReservationType      // CART, ORDER, SYSTEM
  referenceId             String
  
  // Reservation management
  status                  ReservationStatus    @default(ACTIVE)
  priority                ReservationPriority  @default(CART)
  expiresAt               DateTime?            // null for permanent reservations
  
  // Hierarchy for reservation conversion
  parentReservationId     String?              // Original reservation (for conversions)
  convertedToReservationId String?             // New reservation (when converted)
  
  // Audit trail
  createdBy               String?
  releasedBy              String?
  releasedAt              DateTime?
  releaseReason           String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  
  // Relations
  variant                 ProductVariant       @relation(fields: [variantId], references: [id], onDelete: Cascade)
  cart                    Cart?                @relation("CartReservations", fields: [referenceId], references: [id], onDelete: Cascade)
  order                   Order?               @relation("OrderReservations", fields: [referenceId], references: [id], onDelete: Cascade)
  parentReservation       InventoryReservation? @relation("ReservationHierarchy", fields: [parentReservationId], references: [id])
  childReservations       InventoryReservation[] @relation("ReservationHierarchy")
  
  @@index([variantId])
  @@index([referenceType, referenceId])
  @@index([status])
  @@index([expiresAt])
  @@index([priority])
  
  @@map("inventory_reservations")
}

// Price change history for cart items
model CartPriceHistory {
  id                   String               @id @default(cuid())
  cartItemId           String
  cartId               String
  oldUnitPrice         Decimal              @db.Decimal(10, 2)
  newUnitPrice         Decimal              @db.Decimal(10, 2)
  priceChangeReason    String?
  changedAt            DateTime             @default(now())
  
  // Relations
  cartItem             CartItem             @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  cart                 Cart                 @relation("CartPriceHistory", fields: [cartId], references: [id], onDelete: Cascade)
  
  @@index([cartItemId])
  @@index([cartId])
  @@index([changedAt])
  
  @@map("cart_price_history")
}

// Comprehensive audit log for cart operations
model CartAuditLog {
  id                   String               @id @default(cuid())
  cartId               String
  action               CartAction           // CREATED, ITEM_ADDED, ITEM_REMOVED, etc.
  actorId              String?
  actorType            ActorType            @default(USER)
  details              Json                 @default("{}")
  ipAddress            String?
  userAgent            String?
  occurredAt           DateTime             @default(now())
  
  // Relations
  cart                 Cart                 @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  @@index([cartId])
  @@index([actorId])
  @@index([occurredAt])
  @@index([action])
  
  @@map("cart_audit_logs")
}

// Enums for type safety
enum CartStatus {
  ACTIVE
  EXPIRED
  CONVERTED
  ABANDONED
  MERGED
}

enum ReservationType {
  CART
  ORDER
  SYSTEM
}

enum ReservationStatus {
  ACTIVE
  EXPIRED
  CONVERTED
  RELEASED
}

enum ReservationPriority {
  CART
  ORDER
  SYSTEM
}

enum PromotionType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  BUY_X_GET_Y
  FREE_SHIPPING
  BUNDLE_DISCOUNT
}

enum CartAction {
  CREATED
  ITEM_ADDED
  ITEM_REMOVED
  ITEM_QUANTITY_UPDATED
  PROMOTION_APPLIED
  PROMOTION_REMOVED
  PRICE_UPDATED
  MERGED
  CONVERTED
  EXPIRED
  ABANDONED
}

enum ActorType {
  USER
  SYSTEM
  ADMIN
  GUEST
}

// Add these relations to existing models:

// Add to User model:
// carts                Cart[]

// Add to ProductVariant model:
// cartItems            CartItem[]
// reservations         InventoryReservation[]

// Add to Order model:
// appliedPromotions    AppliedPromotion[]
// reservations         InventoryReservation[] @relation("OrderReservations")

// Add to Promotion model:
// appliedPromotions    AppliedPromotion[]