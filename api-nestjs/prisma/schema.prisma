generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id             String          @id @default(cuid())
  name           String
  slug           String          @unique
  type           String
  status         String          @default("ACTIVE")
  settings       Json            @default("{}")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  apiKeys        ApiKey[]
  tenantFeatures TenantFeature[]
  userTenants    UserTenant[]
  
  // Notification Relations
  notifications         Notification[]        @relation("NotificationTenant")
  templates             NotificationTemplate[] @relation("TemplateTenant")
  layouts               NotificationLayout[]  @relation("LayoutTenant")
  preferences           NotificationPreference[] @relation("PreferenceTenant")
  subscriptions         NotificationSubscription[] @relation("SubscriptionTenant")
  webhookSubscriptions  WebhookSubscription[] @relation("WebhookTenant")
  batches               NotificationBatch[]   @relation("BatchTenant")
  rateLimits            NotificationRateLimit[] @relation("RateLimitTenant")
  rules                 NotificationRule[]    @relation("RuleTenant")
  providers             NotificationProvider[] @relation("ProviderTenant")
  auditLogs             NotificationAuditLog[] @relation("AuditTenant")
  metrics               NotificationMetrics[] @relation("MetricsTenant")

  @@map("tenants")
}

model UserTenant {
  id       String   @id @default(cuid())
  userId   String
  tenantId String
  roles    String[] @default([])
  status   String   @default("ACTIVE")
  joinedAt DateTime @default(now())
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

model Feature {
  id             String          @id @default(cuid())
  name           String          @unique
  description    String?
  isActive       Boolean         @default(true)
  tenantFeatures TenantFeature[]

  @@map("features")
}

model TenantFeature {
  id        String  @id @default(cuid())
  tenantId  String
  featureId String
  isEnabled Boolean @default(true)
  config    Json    @default("{}")
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureId])
  @@map("tenant_features")
}

model User {
  id                        String                   @id @default(cuid())
  email                     String                   @unique
  name                      String
  phone                     String?
  password                  String
  roles                     String[]                 @default(["BUYER"])
  status                    String                   @default("ACTIVE")
  isEmailVerified           Boolean                  @default(false)
  isPhoneVerified           Boolean                  @default(false)
  lastLoginAt               DateTime?
  deletedAt                 DateTime?
  deletedBy                 String?
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  addresses                 Address[]
  applicationsReviewed      Application[]            @relation("ApplicationReviewer")
  applications              Application[]
  attributesCreated         Attribute[]              @relation("AttributeCreator")
  attributesDeleted         Attribute[]              @relation("AttributeDeleter")
  attributesUpdated         Attribute[]              @relation("AttributeUpdater")
  auditLogsAsActor          AuditLog[]               @relation("AuditActor")
  bannersCreated            Banner[]
  campaignsCreated          Campaign[]
  carts                     Cart[]
  categoryAttributesCreated CategoryAttribute[]      @relation("CategoryAttributeCreator")
  featureFlagsCreated       FeatureFlag[]
  jobsPosted                Job[]
  mediaFiles                MediaFile[]
  orders                    Order[]
  reviewHelpful             ReviewHelpful[]
  reviewsModerated          Review[]                 @relation("ReviewModerator")
  reviews                   Review[]
  sellerProfile             SellerProfile?
  userRoles                 UserRole[]
  userTenants               UserTenant[]
  
  // Settlement Relations
  sellerAccount             SellerAccount?           @relation("SellerAccount")
  sellerWallet              SellerWallet?            @relation("SellerWallet")
  settlements               Settlement[]             @relation("SellerSettlement")
  settlementSchedules       SettlementSchedule[]     @relation("SellerSchedule")
  
  // Brand domain relations
  brandRequestsAsRequester  BrandRequest[]           @relation("BrandRequestRequester")
  brandRequestsAsHandler    BrandRequest[]           @relation("BrandRequestHandler")
  brandAccessAsSeller       BrandAccess[]            @relation("BrandAccessSeller")
  brandAccessAsGranter      BrandAccess[]            @relation("BrandAccessGranter")
  brandAccessAsRevoker      BrandAccess[]            @relation("BrandAccessRevoker")
  brandAuditLogs            BrandAuditLog[]          @relation("BrandAuditUser")
  categoryAuditLogs         CategoryAuditLog[]       @relation("CategoryAuditUser")
  
  // Notification Relations
  notifications             Notification[]           @relation("NotificationUser")
  notificationPreferences   NotificationPreference[]
  subscriptions             NotificationSubscription[] @relation("SubscriptionUser")
  webhookSubscriptions      WebhookSubscription[]    @relation("WebhookUser")
  webhooksCreated           WebhookSubscription[]    @relation("WebhookCreator")
  templatesCreated          NotificationTemplate[]   @relation("TemplateCreator")
  templatesUpdated          NotificationTemplate[]   @relation("TemplateUpdater")
  layoutsCreated            NotificationLayout[]     @relation("LayoutCreator")
  batchesCreated            NotificationBatch[]      @relation("BatchCreator")
  rulesCreated              NotificationRule[]       @relation("RuleCreator")
  providersCreated          NotificationProvider[]   @relation("ProviderCreator")
  auditLogs                 NotificationAuditLog[]   @relation("AuditUser")
  metrics                   NotificationMetrics[]    @relation("MetricsUser")

  @@map("users")
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  type         String   @default("HOME")
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String
  postalCode   String
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@map("addresses")
}

model SellerProfile {
  id                String     @id @default(cuid())
  userId            String     @unique
  businessName      String
  businessType      String
  gstNumber         String?
  panNumber         String
  businessAddress   Json
  bankDetails       Json
  status            String     @default("DRAFT")
  verificationLevel String     @default("NONE")
  approvedAt        DateTime?
  approvedBy        String?
  rejectedAt        DateTime?
  rejectedBy        String?
  rejectionReason   String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  brands            Brand[]
  cartItems         CartItem[]
  products          Product[]
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("seller_profiles")
}

model Category {
  id          String              @id @default(cuid())
  name        String
  description String
  slug        String              @unique
  parentId    String?
  isActive    Boolean             @default(true)
  sortOrder   Int                 @default(0)
  imageUrl    String?
  level       Int                 @default(0)
  path        String
  pathIds     String[]            @default([])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  parent      Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]          @relation("CategoryHierarchy")
  attributes  CategoryAttribute[]
  brands      CategoryBrand[]
  products    Product[]
  auditLogs   CategoryAuditLog[]  @relation("CategoryAuditCategory")

  @@map("categories")
}

model Attribute {
  id               String                  @id @default(cuid())
  name             String
  slug             String                  @unique
  description      String?
  dataType         String
  inputType        String?
  isRequired       Boolean                 @default(false)
  isVariant        Boolean                 @default(false)
  isFilterable     Boolean                 @default(true)
  isSearchable     Boolean                 @default(false)
  isComparable     Boolean                 @default(false)
  displayOrder     Int                     @default(0)
  groupName        String?
  helpText         String?
  placeholder      String?
  visibility       String                  @default("PUBLIC")
  adminOnly        Boolean                 @default(false)
  isLocalizable    Boolean                 @default(false)
  status           String                  @default("DRAFT")
  createdBy        String
  updatedBy        String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  deletedAt        DateTime?
  deletedBy        String?
  localizations    AttributeLocalization[]
  attributeOptions AttributeOption[]
  creator          User                    @relation("AttributeCreator", fields: [createdBy], references: [id])
  deleter          User?                   @relation("AttributeDeleter", fields: [deletedBy], references: [id])
  updater          User?                   @relation("AttributeUpdater", fields: [updatedBy], references: [id])
  productValues    ProductAttributeValue[]
  variantValues    VariantAttributeValue[]

  @@map("attributes")
}

model AttributeOption {
  id           String    @id @default(cuid())
  attributeId  String
  value        String
  label        String
  description  String?
  color        String?
  imageUrl     String?
  displayOrder Int       @default(0)
  isDefault    Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@map("attribute_options")
}

model AttributeLocalization {
  id          String    @id @default(cuid())
  attributeId String
  locale      String
  name        String
  description String?
  helpText    String?
  placeholder String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeId, locale])
  @@map("attribute_localizations")
}

model CategoryAttribute {
  id              String   @id @default(cuid())
  categoryId      String
  name            String
  slug            String
  type            String
  description     String?
  isRequired      Boolean  @default(false)
  isInheritable   Boolean  @default(false)
  isOverridable   Boolean  @default(false)
  isVariant       Boolean  @default(false)
  isFilterable    Boolean  @default(false)
  isSearchable    Boolean  @default(false)
  defaultValue    String?
  allowedValues   String[]
  validationRules Json?
  displayOrder    Int      @default(0)
  displayName     String?
  helpText        String?
  placeholder     String?
  inheritedFrom   String?
  overriddenAt    String?
  createdBy       String
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  version         Int      @default(1)
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdByUser   User     @relation("CategoryAttributeCreator", fields: [createdBy], references: [id])

  @@unique([categoryId, slug])
  @@map("category_attributes")
}

model CategoryAttributeInheritance {
  id                String   @id @default(cuid())
  sourceAttributeId String
  targetCategoryId  String
  isActive          Boolean  @default(true)
  isOverridden      Boolean  @default(false)
  overriddenValues  Json?
  version           Int      @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([sourceAttributeId, targetCategoryId])
  @@map("category_attribute_inheritance")
}

model Brand {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?
  logoUrl     String?
  isActive    Boolean         @default(true)
  sellerId    String?
  status      String          @default("PENDING")
  approvedAt  DateTime?
  approvedBy  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  seller      SellerProfile?  @relation(fields: [sellerId], references: [id])
  categories  CategoryBrand[]
  products    Product[]
  requests    BrandRequest[]  @relation("BrandRequestBrand")
  auditLogs   BrandAuditLog[] @relation("BrandAuditBrand")
  brandAccess BrandAccess[]   @relation("BrandAccessBrand")

  @@map("brands")
}

model CategoryBrand {
  categoryId String
  brandId    String
  createdAt  DateTime @default(now())
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([categoryId, brandId])
  @@map("category_brands")
}

model Product {
  id               String                  @id @default(cuid())
  name             String
  description      String
  slug             String                  @unique
  categoryId       String
  brandId          String?
  sellerId         String
  status           String                  @default("DRAFT")
  isActive         Boolean                 @default(false)
  isFeatured       Boolean                 @default(false)
  hasVariants      Boolean                 @default(false)
  moderationStatus String?
  approvedAt       DateTime?
  approvedBy       String?
  rejectedAt       DateTime?
  rejectedBy       String?
  rejectionReason  String?
  updatedBy        String?
  deletedAt        DateTime?
  deletedBy        String?
  version          Int                     @default(1)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  attributeValues  ProductAttributeValue[]
  images           ProductImage[]
  variants         ProductVariant[]
  brand            Brand?                  @relation(fields: [brandId], references: [id])
  category         Category                @relation(fields: [categoryId], references: [id])
  seller           SellerProfile           @relation(fields: [sellerId], references: [id])

  @@map("products")
}

model ProductAttributeValue {
  id           String    @id @default(cuid())
  productId    String
  attributeId  String
  value        Json
  stringValue  String?
  numberValue  Float?
  booleanValue Boolean?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@map("product_attribute_values")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id              String                  @id @default(cuid())
  productId       String
  sku             String                  @unique
  variantKey      String
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reservations    InventoryReservation[]  // New relation
  product         Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValues VariantAttributeValue[]
  images          VariantImage[]
  inventory       VariantInventory?
  pricing         VariantPricing?

  @@unique([productId, variantKey])
  @@map("product_variants")
}

model VariantAttributeValue {
  id          String         @id @default(cuid())
  variantId   String
  attributeId String
  value       Json
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  attribute   Attribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
  @@map("variant_attribute_values")
}

model VariantImage {
  id        String         @id @default(cuid())
  variantId String
  url       String
  altText   String?
  sortOrder Int            @default(0)
  createdAt DateTime       @default(now())
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_images")
}

model VariantPricing {
  id           String         @id @default(cuid())
  variantId    String         @unique
  mrp          Decimal        @db.Decimal(10, 2)
  sellingPrice Decimal        @db.Decimal(10, 2)
  costPrice    Decimal?       @db.Decimal(10, 2)
  discount     Decimal?       @db.Decimal(5, 2)
  isActive     Boolean        @default(true)
  validFrom    DateTime       @default(now())
  validTo      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  variant      ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_pricing")
}

model VariantInventory {
  id                String                 @id @default(cuid())
  variantId         String                 @unique
  quantity          Int                    @default(0)
  reservedQuantity  Int                    @default(0)
  availableQuantity Int                    @default(0)
  lowStockThreshold Int                    @default(5)
  isTrackingEnabled Boolean                @default(true)
  lastUpdatedAt     DateTime               @default(now())
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  movements         InventoryMovement[]
  variant           ProductVariant         @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_inventory")
}


model InventoryMovement {
  id          String           @id @default(cuid())
  inventoryId String
  type        String
  quantity    Int
  reason      String
  reference   String?
  createdBy   String
  createdAt   DateTime         @default(now())
  inventory   VariantInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@map("inventory_movements")
}

model CommissionRule {
  id          String    @id @default(cuid())
  name        String
  
  // Rule Configuration
  type        String    // PERCENTAGE, FIXED, TIERED
  entityType  String    // GLOBAL, CATEGORY, SELLER, PRODUCT
  entityId    String?   // Category/Seller/Product ID
  
  // Commission Rates
  rate        Decimal?  @db.Decimal(5, 4) // Percentage (0.0000 to 1.0000)
  fixedAmount Decimal?  @db.Decimal(15, 2)
  
  // Tiered Configuration (JSON)
  tiers       Json?     // For tiered commission structure
  
  // Limits
  minAmount   Decimal?  @db.Decimal(15, 2)
  maxAmount   Decimal?  @db.Decimal(15, 2)
  
  // Validity
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  
  // Priority & Status
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  
  // Metadata
  description String?
  metadata    Json      @default("{}")
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("commission_rules")
}

model Order {
  id                String                 @id @default(cuid())
  orderNumber       String                 @unique
  userId            String
  status            String                 @default("PENDING")
  totalAmount       Decimal                @db.Decimal(10, 2)
  discountAmount    Decimal                @default(0) @db.Decimal(10, 2)
  taxAmount         Decimal                @default(0) @db.Decimal(10, 2)
  shippingAmount    Decimal                @default(0) @db.Decimal(10, 2)
  finalAmount       Decimal                @db.Decimal(10, 2)
  paymentStatus     String                 @default("PENDING")
  shippingAddressId String
  billingAddressId  String?
  notes             String?
  cancelledAt       DateTime?
  cancelReason      String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  appliedPromotions AppliedPromotion[]     // New relation
  items             OrderItem[]
  shippingAddress   Address                @relation(fields: [shippingAddressId], references: [id])
  user              User                   @relation(fields: [userId], references: [id])
  payments          Payment[]
  reviews           Review[]
  shipments         Shipment[]
  paymentIntents    PaymentIntent[]        @relation("PaymentIntentOrder")
  settlementTransactions SettlementTransaction[]
  walletTransactions SellerWalletTransaction[]

  @@map("orders")
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  variantId        String
  quantity         Int
  unitPrice        Decimal        @db.Decimal(10, 2)
  totalPrice       Decimal        @db.Decimal(10, 2)
  discountAmount   Decimal        @default(0) @db.Decimal(10, 2)
  taxAmount        Decimal        @default(0) @db.Decimal(10, 2)
  commissionRate   Decimal        @db.Decimal(5, 2)
  commissionAmount Decimal        @db.Decimal(10, 2)
  productSnapshot  Json
  variantSnapshot  Json
  pricingSnapshot  Json
  createdAt        DateTime       @default(now())
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant          ProductVariant @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Payment {
  id              String    @id @default(cuid())
  orderId         String
  paymentIntentId String    @unique
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("INR")
  status          String    @default("PENDING")
  paymentMethod   String
  gatewayResponse Json?
  failureReason   String?
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================================================
// SETTLEMENT & PAYOUT MODELS
// ============================================================================

model SellerAccount {
  id                    String                @id @default(cuid())
  sellerId              String                @unique
  accountHolderName     String
  accountNumber         String
  ifscCode              String
  bankName              String
  branchName            String?
  accountType           String                @default("SAVINGS") // SAVINGS, CURRENT
  upiId                 String?
  
  // KYC & Verification
  kycStatus             String                @default("PENDING") // PENDING, SUBMITTED, VERIFIED, REJECTED
  kycDocuments          Json?
  verificationDetails   Json?
  verifiedAt            DateTime?
  
  // Account Status
  status                String                @default("ACTIVE") // ACTIVE, SUSPENDED, CLOSED
  isVerified            Boolean               @default(false)
  
  // Razorpay Integration
  razorpayAccountId     String?               @unique
  razorpayContactId     String?
  razorpayFundAccountId String?
  
  // Business Details
  businessName          String?
  businessType          String?               // INDIVIDUAL, PARTNERSHIP, PRIVATE_LIMITED, etc.
  gstNumber             String?
  panNumber             String?
  
  // Metadata
  metadata              Json                  @default("{}")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  seller                User                  @relation("SellerAccount", fields: [sellerId], references: [id])
  settlements           Settlement[]
  walletTransactions    SellerWalletTransaction[]
  schedules             SettlementSchedule[]
  
  @@map("seller_accounts")
}

model SellerWallet {
  id                    String                @id @default(cuid())
  sellerId              String                @unique
  
  // Balance Information
  availableBalance      Decimal               @default(0) @db.Decimal(15, 2)
  pendingBalance        Decimal               @default(0) @db.Decimal(15, 2)
  reservedBalance       Decimal               @default(0) @db.Decimal(15, 2)
  totalBalance          Decimal               @default(0) @db.Decimal(15, 2)
  
  // Currency
  currency              String                @default("INR")
  
  // Last Settlement
  lastSettlementAt      DateTime?
  lastSettlementAmount  Decimal?              @db.Decimal(15, 2)
  
  // Metadata
  metadata              Json                  @default("{}")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  seller                User                  @relation("SellerWallet", fields: [sellerId], references: [id])
  transactions          SellerWalletTransaction[]
  
  @@map("seller_wallets")
}

model SellerWalletTransaction {
  id                    String                @id @default(cuid())
  walletId              String
  sellerAccountId       String?
  
  // Transaction Details
  transactionId         String                @unique
  type                  String                // CREDIT, DEBIT
  category              String                // SALE, COMMISSION, FEE, TAX, REFUND, SETTLEMENT, ADJUSTMENT
  amount                Decimal               @db.Decimal(15, 2)
  currency              String                @default("INR")
  
  // Balance Snapshots
  balanceBefore         Decimal               @db.Decimal(15, 2)
  balanceAfter          Decimal               @db.Decimal(15, 2)
  
  // Reference Information
  referenceType         String?               // ORDER, PAYMENT, SETTLEMENT, REFUND
  referenceId           String?
  orderId               String?
  paymentId             String?
  settlementId          String?
  
  // Description & Metadata
  description           String
  metadata              Json                  @default("{}")
  
  // Timestamps
  processedAt           DateTime              @default(now())
  createdAt             DateTime              @default(now())
  
  // Relations
  wallet                SellerWallet          @relation(fields: [walletId], references: [id])
  sellerAccount         SellerAccount?        @relation(fields: [sellerAccountId], references: [id])
  order                 Order?                @relation(fields: [orderId], references: [id])
  
  @@map("seller_wallet_transactions")
}

model Settlement {
  id                    String                @id @default(cuid())
  settlementId          String                @unique
  sellerId              String
  sellerAccountId       String
  
  // Settlement Period
  periodStart           DateTime
  periodEnd             DateTime
  
  // Amount Breakdown
  grossAmount           Decimal               @db.Decimal(15, 2)
  commissionAmount      Decimal               @db.Decimal(15, 2)
  platformFeeAmount     Decimal               @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal               @default(0) @db.Decimal(15, 2)
  adjustmentAmount      Decimal               @default(0) @db.Decimal(15, 2)
  netAmount             Decimal               @db.Decimal(15, 2)
  
  // Currency
  currency              String                @default("INR")
  
  // Status & Lifecycle
  status                String                @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  
  // Settlement Details
  settlementDate        DateTime?
  scheduledDate         DateTime?
  processedAt           DateTime?
  completedAt           DateTime?
  failedAt              DateTime?
  
  // Razorpay Integration
  razorpayPayoutId      String?               @unique
  razorpayTransferId    String?
  gatewayResponse       Json?
  
  // Failure Information
  failureReason         String?
  failureCode           String?
  retryCount            Int                   @default(0)
  maxRetries            Int                   @default(3)
  nextRetryAt           DateTime?
  
  // Reconciliation
  isReconciled          Boolean               @default(false)
  reconciledAt          DateTime?
  reconciledBy          String?
  
  // Locking & Concurrency
  version               Int                   @default(1)
  lockedAt              DateTime?
  lockedBy              String?
  
  // Metadata
  metadata              Json                  @default("{}")
  notes                 String?
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  seller                User                  @relation("SellerSettlement", fields: [sellerId], references: [id])
  sellerAccount         SellerAccount         @relation(fields: [sellerAccountId], references: [id])
  transactions          SettlementTransaction[]
  auditLogs             SettlementAuditLog[]
  
  @@map("settlements")
}

model SettlementTransaction {
  id                    String                @id @default(cuid())
  settlementId          String
  
  // Transaction Reference
  referenceType         String                // ORDER, REFUND, ADJUSTMENT, FEE
  referenceId           String
  orderId               String?
  orderItemId           String?
  paymentId             String?
  
  // Amount Details
  grossAmount           Decimal               @db.Decimal(15, 2)
  commissionRate        Decimal               @db.Decimal(5, 4)
  commissionAmount      Decimal               @db.Decimal(15, 2)
  platformFeeAmount     Decimal               @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal               @default(0) @db.Decimal(15, 2)
  netAmount             Decimal               @db.Decimal(15, 2)
  
  // Currency
  currency              String                @default("INR")
  
  // Transaction Details
  description           String
  transactionDate       DateTime
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Timestamps
  createdAt             DateTime              @default(now())
  
  // Relations
  settlement            Settlement            @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  order                 Order?                @relation(fields: [orderId], references: [id])
  
  @@map("settlement_transactions")
}

model SettlementSchedule {
  id                    String                @id @default(cuid())
  sellerId              String
  sellerAccountId       String
  
  // Schedule Configuration
  frequency             String                @default("WEEKLY") // DAILY, WEEKLY, MONTHLY, MANUAL
  dayOfWeek             Int?                  // 1-7 for weekly (1=Monday)
  dayOfMonth            Int?                  // 1-31 for monthly
  timeOfDay             String?               // HH:MM format
  timezone              String                @default("Asia/Kolkata")
  
  // Settlement Rules
  minimumAmount         Decimal               @default(100) @db.Decimal(15, 2)
  holdPeriodDays        Int                   @default(7)
  
  // Status
  isActive              Boolean               @default(true)
  
  // Next Settlement
  nextSettlementDate    DateTime?
  lastSettlementDate    DateTime?
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  seller                User                  @relation("SellerSchedule", fields: [sellerId], references: [id])
  sellerAccount         SellerAccount         @relation(fields: [sellerAccountId], references: [id])
  
  @@unique([sellerId, sellerAccountId])
  @@map("settlement_schedules")
}

model SettlementJob {
  id                    String                @id @default(cuid())
  jobId                 String                @unique
  
  // Job Details
  type                  String                // BATCH_SETTLEMENT, INDIVIDUAL_SETTLEMENT, RECONCILIATION
  status                String                @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  
  // Job Configuration
  sellerId              String?               // For individual settlements
  batchSize             Int?                  // For batch processing
  periodStart           DateTime?
  periodEnd             DateTime?
  
  // Progress Tracking
  totalItems            Int                   @default(0)
  processedItems        Int                   @default(0)
  successfulItems       Int                   @default(0)
  failedItems           Int                   @default(0)
  
  // Execution Details
  startedAt             DateTime?
  completedAt           DateTime?
  failedAt              DateTime?
  
  // Error Information
  errorMessage          String?
  errorDetails          Json?
  
  // Results
  results               Json?
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@map("settlement_jobs")
}

model SettlementAuditLog {
  id                    String                @id @default(cuid())
  settlementId          String
  
  // Audit Details
  action                String                // CREATED, UPDATED, PROCESSED, COMPLETED, FAILED, CANCELLED
  oldValues             Json?
  newValues             Json?
  changes               Json?
  
  // Context
  userId                String?
  userRole              String?
  ipAddress             String?
  userAgent             String?
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Timestamp
  createdAt             DateTime              @default(now())
  
  // Relations
  settlement            Settlement            @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  
  @@map("settlement_audit_logs")
}

model Shipment {
  id                String             @id @default(cuid())
  orderId           String
  trackingNumber    String             @unique
  carrier           String
  status            String             @default("PENDING")
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  tracking          ShipmentTracking[]
  order             Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipments")
}

model ShipmentTracking {
  id          String   @id @default(cuid())
  shipmentId  String
  status      String
  location    String?
  description String
  timestamp   DateTime
  createdAt   DateTime @default(now())
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_tracking")
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  changes    Json?
  actorId    String?
  actorType  String   @default("USER")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  actor      User?    @relation("AuditActor", fields: [actorId], references: [id])

  @@map("audit_logs")
}

// Enhanced Cart model with enterprise features
model Cart {
  id                   String               @id @default(cuid())
  userId               String?              // null for guest carts
  sessionId            String?              // for guest identification
  status               CartStatus           @default(ACTIVE)
  
  // Pricing fields with Decimal precision
  subtotal             Decimal              @default(0) @db.Decimal(10, 2)
  discountAmount       Decimal              @default(0) @db.Decimal(10, 2)
  taxAmount            Decimal              @default(0) @db.Decimal(10, 2)
  shippingAmount       Decimal              @default(0) @db.Decimal(10, 2)
  totalAmount          Decimal              @default(0) @db.Decimal(10, 2)
  
  // Promotion tracking
  appliedPromotions    String[]             @default([]) // Legacy field for backward compatibility
  availablePromotions  String[]             @default([]) // Cached eligible promotion IDs
  
  // Localization
  currency             String               @default("INR")
  locale               String               @default("en-IN")
  timezone             String               @default("Asia/Kolkata")
  
  // Lifecycle management
  expiresAt            DateTime?            // 24 hours for guests, 30 days for users
  lastActivityAt       DateTime             @default(now())
  convertedToOrderId   String?              // Order ID when converted
  
  // Optimistic locking
  version              Int                  @default(1)
  
  // Audit fields
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  // Relations
  user                 User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                CartItem[]
  appliedPromotionDetails AppliedPromotion[] @relation("CartPromotions")
  auditLogs            CartAuditLog[]
  priceHistory         CartPriceHistory[]   @relation("CartPriceHistory")
  
  // Indexes for performance
  @@index([userId, status])
  @@index([sessionId, status])
  @@index([expiresAt])
  @@index([lastActivityAt])
  @@index([userId, sessionId, status])
  
  @@map("carts")
}

// Enhanced CartItem model with price tracking and reservations
model CartItem {
  id                   String               @id @default(cuid())
  cartId               String
  variantId            String
  sellerId             String
  
  // Quantity and pricing
  quantity             Int
  unitPrice            Decimal              @db.Decimal(10, 2) // Price when added
  currentUnitPrice     Decimal              @db.Decimal(10, 2) // Current price (may differ)
  totalPrice           Decimal              @db.Decimal(10, 2) // quantity * currentUnitPrice
  discountAmount       Decimal              @default(0) @db.Decimal(10, 2) // Item-level discounts
  
  // Availability and reservations
  isAvailable          Boolean              @default(true)
  availabilityReason   String?              // Reason if not available
  reservationId        String?              // Soft reservation ID
  reservationExpiresAt DateTime?            // When reservation expires
  
  // Tracking
  addedAt              DateTime             @default(now())
  lastCheckedAt        DateTime             @default(now()) // Last availability check
  
  // Snapshots for change detection
  variantSnapshot      Json                 @default("{}")
  pricingSnapshot      Json                 @default("{}")
  
  // Relations
  cart                 Cart                 @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant              ProductVariant       @relation(fields: [variantId], references: [id])
  seller               SellerProfile        @relation(fields: [sellerId], references: [id])
  appliedPromotions    AppliedPromotion[]   @relation("CartItemPromotions")
  priceHistory         CartPriceHistory[]
  
  // Constraints
  @@unique([cartId, variantId, sellerId])
  @@index([variantId])
  @@index([sellerId])
  @@index([reservationId])
  @@index([cartId, variantId, sellerId])
  
  @@map("cart_items")
}

model MediaFile {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  cdnUrl       String?
  type         String
  entityId     String?
  entityType   String?
  metadata     Json     @default("{}")
  status       String   @default("PENDING")
  uploadedBy   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uploader     User     @relation(fields: [uploadedBy], references: [id])

  @@map("media_files")
}

model Review {
  id                 String          @id @default(cuid())
  userId             String
  type               String
  entityId           String
  orderId            String?
  rating             Int
  title              String?
  comment            String?
  images             String[]        @default([])
  status             String          @default("PENDING")
  isVerifiedPurchase Boolean         @default(false)
  helpfulCount       Int             @default(0)
  reportCount        Int             @default(0)
  moderatedBy        String?
  moderatedAt        DateTime?
  moderationReason   String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  helpful            ReviewHelpful[]
  moderator          User?           @relation("ReviewModerator", fields: [moderatedBy], references: [id])
  order              Order?          @relation(fields: [orderId], references: [id])
  user               User            @relation(fields: [userId], references: [id])

  @@unique([userId, type, entityId])
  @@map("reviews")
}

model ReviewHelpful {
  id        String  @id @default(cuid())
  reviewId  String
  userId    String
  isHelpful Boolean
  review    Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
  @@map("review_helpful")
}

model AggregatedRating {
  id            String   @id @default(cuid())
  entityType    String
  entityId      String
  averageRating Float    @default(0)
  totalReviews  Int      @default(0)
  rating1Count  Int      @default(0)
  rating2Count  Int      @default(0)
  rating3Count  Int      @default(0)
  rating4Count  Int      @default(0)
  rating5Count  Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@unique([entityType, entityId])
  @@map("aggregated_ratings")
}

// ============================================================================
// NOTIFICATION SYSTEM ENUMS
// ============================================================================

enum NotificationType {
  // Order Events
  ORDER_CONFIRMATION
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_RETURNED
  ORDER_REFUNDED
  ORDER_DELAYED
  ORDER_READY_FOR_PICKUP

  // Payment Events
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PAYMENT_PENDING
  PAYMENT_REFUNDED
  PAYMENT_DISPUTED
  PAYMENT_CHARGEBACK

  // Product Events
  PRODUCT_APPROVED
  PRODUCT_REJECTED
  PRODUCT_OUT_OF_STOCK
  PRODUCT_BACK_IN_STOCK
  LOW_STOCK_ALERT
  PRICE_DROP_ALERT
  WISHLIST_ITEM_AVAILABLE

  // Seller Events
  SELLER_APPLICATION_APPROVED
  SELLER_APPLICATION_REJECTED
  SELLER_PAYOUT_PROCESSED
  SELLER_PAYOUT_FAILED
  SELLER_ACCOUNT_SUSPENDED
  SELLER_PERFORMANCE_ALERT

  // Promotion Events
  PROMOTION_ACTIVATED
  PROMOTION_EXPIRED
  PROMOTION_APPLIED
  FLASH_SALE_STARTED
  COUPON_EXPIRING_SOON

  // Review Events
  REVIEW_RECEIVED
  REVIEW_APPROVED
  REVIEW_REJECTED
  REVIEW_RESPONSE_RECEIVED

  // System Events
  SYSTEM_MAINTENANCE
  SECURITY_ALERT
  ACCOUNT_LOCKED
  PASSWORD_RESET
  EMAIL_VERIFICATION
  TWO_FACTOR_ENABLED
  LOGIN_FROM_NEW_DEVICE

  // Marketing Events
  MARKETING_CAMPAIGN
  NEWSLETTER
  PROMOTIONAL_OFFER
  ABANDONED_CART_REMINDER
  WELCOME_SERIES

  // Settlement Events
  SETTLEMENT_PROCESSED
  SETTLEMENT_FAILED
  SETTLEMENT_SCHEDULED
  SETTLEMENT_DELAYED

  // Inventory Events
  INVENTORY_ADJUSTMENT
  BULK_IMPORT_COMPLETED
  BULK_IMPORT_FAILED

  // Customer Service Events
  SUPPORT_TICKET_CREATED
  SUPPORT_TICKET_UPDATED
  SUPPORT_TICKET_RESOLVED

  // Compliance Events
  KYC_VERIFICATION_REQUIRED
  KYC_VERIFICATION_APPROVED
  KYC_VERIFICATION_REJECTED
  TAX_DOCUMENT_READY
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
  WEBHOOK
  WHATSAPP
  SLACK
  TEAMS
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  QUEUED
  PROCESSING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
  CANCELLED
  EXPIRED
}

enum NotificationCategory {
  TRANSACTIONAL
  MARKETING
  SYSTEM
  SECURITY
  OPERATIONAL
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
  UNSUBSCRIBED
}

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  TESTING
}

enum PreferenceFrequency {
  IMMEDIATE
  HOURLY
  DAILY
  WEEKLY
  NEVER
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
  FAILED
}

enum BatchStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// CORE NOTIFICATION MODELS
// ============================================================================

model Notification {
  id                    String                @id @default(cuid())
  
  // Basic Information
  type                  NotificationType
  category              NotificationCategory  @default(TRANSACTIONAL)
  priority              NotificationPriority  @default(MEDIUM)
  status                NotificationStatus    @default(PENDING)
  
  // Recipients & Channels
  recipients            Json                  // Array of NotificationRecipient objects
  channels              NotificationChannel[]
  
  // Content & Context
  templateId            String?
  templateVariables     Json                  @default("{}")
  renderedContent       Json?                 // Cached rendered content per channel
  
  // Scheduling & Lifecycle
  scheduledAt           DateTime?
  expiresAt             DateTime?
  processedAt           DateTime?
  completedAt           DateTime?
  
  // Tracking & Metadata
  correlationId         String?               // For tracing related notifications
  causationId           String?               // Event that caused this notification
  idempotencyKey        String?               @unique
  batchId               String?               // For bulk notifications
  
  // Context Information
  tenantId              String?
  userId                String?               // Primary recipient user ID
  source                String                // Service that created the notification
  metadata              Json                  @default("{}")
  
  // Audit Fields
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  version               Int                   @default(1)
  
  // Relations
  user                  User?                 @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)
  tenant                Tenant?               @relation("NotificationTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  template              NotificationTemplate? @relation(fields: [templateId], references: [id])
  deliveries            NotificationDelivery[]
  events                NotificationEvent[]
  batch                 NotificationBatch?    @relation(fields: [batchId], references: [id])
  
  // Indexes for performance
  @@index([type, status])
  @@index([userId, status])
  @@index([tenantId, status])
  @@index([scheduledAt])
  @@index([expiresAt])
  @@index([correlationId])
  @@index([batchId])
  @@index([createdAt])
  
  @@map("notifications")
}

model NotificationDelivery {
  id                    String                @id @default(cuid())
  notificationId        String
  
  // Delivery Details
  channel               NotificationChannel
  recipient             Json                  // NotificationRecipient object
  status                DeliveryStatus        @default(PENDING)
  
  // Message Information
  messageId             String?               // External provider message ID
  subject               String?
  content               String?
  htmlContent           String?
  
  // Delivery Tracking
  sentAt                DateTime?
  deliveredAt           DateTime?
  openedAt              DateTime?
  clickedAt             DateTime?
  bouncedAt             DateTime?
  unsubscribedAt        DateTime?
  
  // Error Handling
  attempts              Int                   @default(0)
  maxAttempts           Int                   @default(3)
  nextRetryAt           DateTime?
  errorCode             String?
  errorMessage          String?
  errorDetails          Json?
  
  // Provider Information
  providerId            String?               // Which provider was used
  providerMessageId     String?               // Provider's message ID
  providerResponse      Json?                 // Full provider response
  
  // Costs & Analytics
  cost                  Decimal?              @db.Decimal(10, 4) // Cost in cents
  currency              String?               @default("USD")
  
  // Metadata
  metadata              Json                  @default("{}")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  notification          Notification          @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([notificationId])
  @@index([channel, status])
  @@index([status, nextRetryAt])
  @@index([sentAt])
  @@index([deliveredAt])
  
  @@map("notification_deliveries")
}

model NotificationTemplate {
  id                    String                @id @default(cuid())
  
  // Template Identity
  name                  String
  type                  NotificationType
  channel               NotificationChannel
  category              NotificationCategory
  
  // Localization
  locale                String                @default("en")
  
  // Content
  subject               String?               // For email/push
  title                 String?               // For push/in-app
  content               String                // Main content (supports templating)
  htmlContent           String?               // HTML version for email
  
  // Template Configuration
  variables             String[]              @default([]) // Required variables
  defaultVariables      Json                  @default("{}")
  
  // Layout & Styling
  layoutId              String?
  styles                Json?                 // CSS/styling information
  
  // Status & Versioning
  status                TemplateStatus        @default(DRAFT)
  version               Int                   @default(1)
  isDefault             Boolean               @default(false)
  
  // Tenant & Permissions
  tenantId              String?
  isGlobal              Boolean               @default(false)
  
  // A/B Testing
  testGroup             String?               // For A/B testing
  testPercentage        Int?                  // Percentage of users to receive this variant
  
  // Metadata
  description           String?
  tags                  String[]              @default([])
  metadata              Json                  @default("{}")
  
  // Audit
  createdBy             String
  updatedBy             String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("TemplateTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator               User                  @relation("TemplateCreator", fields: [createdBy], references: [id])
  updater               User?                 @relation("TemplateUpdater", fields: [updatedBy], references: [id])
  layout                NotificationLayout?   @relation(fields: [layoutId], references: [id])
  notifications         Notification[]
  localizations         NotificationTemplateLocalization[]
  batches               NotificationBatch[]
  
  // Constraints
  @@unique([type, channel, locale, tenantId])
  @@index([type, channel])
  @@index([tenantId, status])
  @@index([status, isDefault])
  
  @@map("notification_templates")
}

model NotificationTemplateLocalization {
  id                    String                @id @default(cuid())
  templateId            String
  locale                String
  
  // Localized Content
  subject               String?
  title                 String?
  content               String
  htmlContent           String?
  
  // Metadata
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  template              NotificationTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([templateId, locale])
  @@map("notification_template_localizations")
}

model NotificationLayout {
  id                    String                @id @default(cuid())
  
  // Layout Information
  name                  String
  description           String?
  channel               NotificationChannel
  
  // Layout Content
  headerContent         String?
  footerContent         String?
  styles                Json?                 // CSS/styling
  
  // Configuration
  isDefault             Boolean               @default(false)
  tenantId              String?
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("LayoutTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator               User                  @relation("LayoutCreator", fields: [createdBy], references: [id])
  templates             NotificationTemplate[]
  
  @@unique([name, channel, tenantId])
  @@map("notification_layouts")
}

// ============================================================================
// USER PREFERENCES & SETTINGS
// ============================================================================

model NotificationPreference {
  id                    String                @id @default(cuid())
  
  // User & Context
  userId                String
  tenantId              String?
  type                  String                // NotificationType or 'ALL'
  category              NotificationCategory?
  
  // Channel Preferences
  channels              NotificationChannel[] @default([]) // Enabled channels
  isEnabled             Boolean               @default(true)
  
  // Frequency Control
  frequency             PreferenceFrequency   @default(IMMEDIATE)
  batchingEnabled       Boolean               @default(false)
  maxBatchSize          Int                   @default(10)
  
  // Quiet Hours
  quietHoursEnabled     Boolean               @default(false)
  quietHoursStart       String?               // HH:mm format
  quietHoursEnd         String?               // HH:mm format
  timezone              String                @default("UTC")
  
  // Advanced Settings
  priority              NotificationPriority? // Minimum priority to receive
  keywords              String[]              @default([]) // Keyword filters
  excludeKeywords       String[]              @default([]) // Keywords to exclude
  
  // Metadata
  metadata              Json                  @default("{}")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant                Tenant?               @relation("PreferenceTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, type, tenantId])
  @@index([userId, tenantId])
  @@index([type, category])
  
  @@map("notification_preferences")
}

model NotificationSubscription {
  id                    String                @id @default(cuid())
  
  // Subscription Details
  userId                String?
  email                 String?
  phone                 String?
  deviceToken           String?
  
  // Subscription Type
  type                  String                // EMAIL_LIST, SMS_LIST, PUSH_DEVICE
  status                String                @default("ACTIVE") // ACTIVE, UNSUBSCRIBED, BOUNCED
  
  // Subscription Metadata
  source                String?               // How they subscribed
  ipAddress             String?
  userAgent             String?
  
  // Consent & Compliance
  consentGiven          Boolean               @default(false)
  consentTimestamp      DateTime?
  consentMethod         String?               // EXPLICIT, IMPLIED, LEGITIMATE_INTEREST
  
  // Unsubscribe Information
  unsubscribedAt        DateTime?
  unsubscribeReason     String?
  unsubscribeMethod     String?               // LINK, REPLY, ADMIN
  
  // Tenant Context
  tenantId              String?
  
  // Audit
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  user                  User?                 @relation("SubscriptionUser", fields: [userId], references: [id], onDelete: Cascade)
  tenant                Tenant?               @relation("SubscriptionTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([email, type])
  @@index([phone, type])
  @@index([deviceToken, type])
  @@index([userId, type])
  @@index([status])
  
  @@map("notification_subscriptions")
}

// ============================================================================
// WEBHOOK SYSTEM
// ============================================================================

model WebhookSubscription {
  id                    String                @id @default(cuid())
  
  // Subscription Details
  name                  String
  url                   String
  events                NotificationType[]    // Array of NotificationType values
  
  // Authentication
  secret                String?               // HMAC secret
  headers               Json?                 // Custom headers
  
  // Configuration
  isActive              Boolean               @default(true)
  timeout               Int                   @default(30) // Seconds
  
  // Retry Policy
  maxRetries            Int                   @default(3)
  retryBackoff          String                @default("EXPONENTIAL") // LINEAR, EXPONENTIAL
  retryMultiplier       Float                 @default(2.0)
  maxRetryDelay         Int                   @default(300) // Seconds
  
  // Filtering
  filters               Json?                 // Event filtering rules
  
  // Tenant & User Context
  tenantId              String?
  userId                String?
  
  // Status & Health
  status                WebhookStatus         @default(ACTIVE)
  lastSuccessAt         DateTime?
  lastFailureAt         DateTime?
  consecutiveFailures   Int                   @default(0)
  
  // Metadata
  description           String?
  tags                  String[]              @default([])
  metadata              Json                  @default("{}")
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("WebhookTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User?                 @relation("WebhookUser", fields: [userId], references: [id], onDelete: Cascade)
  creator               User                  @relation("WebhookCreator", fields: [createdBy], references: [id])
  deliveries            WebhookDelivery[]
  
  @@index([tenantId, status])
  @@index([userId, status])
  @@index([status])
  
  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id                    String                @id @default(cuid())
  subscriptionId        String
  
  // Event Information
  eventType             NotificationType
  eventId               String?               // Original event ID
  payload               Json
  
  // Delivery Details
  status                String                @default("PENDING") // PENDING, SUCCESS, FAILED, CANCELLED
  httpMethod            String                @default("POST")
  url                   String
  headers               Json?
  
  // Response Information
  responseStatus        Int?
  responseHeaders       Json?
  responseBody          String?
  responseTime          Int?                  // Milliseconds
  
  // Retry Information
  attempts              Int                   @default(0)
  nextRetryAt           DateTime?
  
  // Error Information
  errorCode             String?
  errorMessage          String?
  errorDetails          Json?
  
  // Timestamps
  scheduledAt           DateTime              @default(now())
  sentAt                DateTime?
  completedAt           DateTime?
  
  // Relations
  subscription          WebhookSubscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId, status])
  @@index([status, nextRetryAt])
  @@index([eventType])
  @@index([scheduledAt])
  
  @@map("webhook_deliveries")
}

// ============================================================================
// BATCH PROCESSING & CAMPAIGNS
// ============================================================================

model NotificationBatch {
  id                    String                @id @default(cuid())
  
  // Batch Information
  name                  String?
  type                  String                // BULK_NOTIFICATION, CAMPAIGN, SCHEDULED
  status                BatchStatus           @default(PENDING)
  
  // Processing Details
  totalRecipients       Int                   @default(0)
  processedRecipients   Int                   @default(0)
  successfulDeliveries  Int                   @default(0)
  failedDeliveries      Int                   @default(0)
  
  // Template Configuration
  templateId            String?
  templateVariables     Json                  @default("{}")
  channels              NotificationChannel[] @default([])
  
  // Configuration
  batchSize             Int                   @default(1000)
  delayBetweenBatches   Int                   @default(1000) // Milliseconds
  
  // Scheduling
  scheduledAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  
  // Tenant Context
  tenantId              String?
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("BatchTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator               User                  @relation("BatchCreator", fields: [createdBy], references: [id])
  template              NotificationTemplate? @relation(fields: [templateId], references: [id])
  notifications         Notification[]
  
  @@index([status])
  @@index([tenantId, status])
  @@index([scheduledAt])
  
  @@map("notification_batches")
}

// ============================================================================
// RATE LIMITING & THROTTLING
// ============================================================================

model NotificationRateLimit {
  id                    String                @id @default(cuid())
  
  // Rate Limit Configuration
  name                  String
  channel               NotificationChannel
  scope                 String                // GLOBAL, TENANT, USER
  scopeId               String?               // Tenant ID or User ID
  
  // Limits
  maxPerMinute          Int?
  maxPerHour            Int?
  maxPerDay             Int?
  maxPerMonth           Int?
  burstLimit            Int?                  // Maximum burst size
  
  // Current Usage (reset periodically)
  currentMinute         Int                   @default(0)
  currentHour           Int                   @default(0)
  currentDay            Int                   @default(0)
  currentMonth          Int                   @default(0)
  
  // Reset Timestamps
  lastResetMinute       DateTime              @default(now())
  lastResetHour         DateTime              @default(now())
  lastResetDay          DateTime              @default(now())
  lastResetMonth        DateTime              @default(now())
  
  // Status
  isActive              Boolean               @default(true)
  
  // Tenant Context
  tenantId              String?
  
  // Audit
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("RateLimitTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([channel, scope, scopeId, tenantId])
  @@index([channel, scope])
  @@index([tenantId])
  
  @@map("notification_rate_limits")
}

// ============================================================================
// ANALYTICS & REPORTING
// ============================================================================

model NotificationMetrics {
  id                    String                @id @default(cuid())
  
  // Metric Dimensions
  date                  DateTime              // Date for the metrics
  hour                  Int?                  // Hour (0-23) for hourly metrics
  
  // Grouping Dimensions
  tenantId              String?
  userId                String?
  type                  NotificationType?
  channel               NotificationChannel?
  category              NotificationCategory?
  
  // Delivery Metrics
  sent                  Int                   @default(0)
  delivered             Int                   @default(0)
  failed                Int                   @default(0)
  bounced               Int                   @default(0)
  
  // Engagement Metrics
  opened                Int                   @default(0)
  clicked               Int                   @default(0)
  unsubscribed          Int                   @default(0)
  
  // Performance Metrics
  avgProcessingTime     Float?                // Average processing time in ms
  avgDeliveryTime       Float?                // Average delivery time in ms
  
  // Cost Metrics
  totalCost             Decimal?              @db.Decimal(10, 4)
  currency              String?               @default("USD")
  
  // Metadata
  metadata              Json                  @default("{}")
  createdAt             DateTime              @default(now())
  
  // Relations
  tenant                Tenant?               @relation("MetricsTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User?                 @relation("MetricsUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([date, hour, tenantId, userId, type, channel, category])
  @@index([date, tenantId])
  @@index([date, type])
  @@index([date, channel])
  
  @@map("notification_metrics")
}

// ============================================================================
// EVENT TRACKING & AUDIT
// ============================================================================

model NotificationEvent {
  id                    String                @id @default(cuid())
  notificationId        String
  
  // Event Details
  type                  String                // READ, CLICKED, BOUNCED, etc.
  eventType             String?               // CREATED, QUEUED, SENT, DELIVERED, OPENED, CLICKED, BOUNCED, FAILED (deprecated, use type)
  channel               NotificationChannel?
  
  // Event Data
  data                  Json?
  
  // Context
  userId                String?
  ipAddress             String?
  userAgent             String?
  
  // Metadata
  metadata              Json                  @default("{}")
  
  // Timestamp
  timestamp             DateTime              @default(now())
  
  // Relations
  notification          Notification          @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  
  @@index([notificationId])
  @@index([type])
  @@index([eventType])
  @@index([userId])
  @@index([timestamp])
  
  @@map("notification_events")
}

model NotificationAuditLog {
  id                    String                @id @default(cuid())
  
  // Audit Information
  entityType            String                // NOTIFICATION, TEMPLATE, PREFERENCE, etc.
  entityId              String
  action                String                // CREATE, UPDATE, DELETE, SEND, etc.
  
  // Changes
  oldValues             Json?
  newValues             Json?
  changes               Json?
  
  // Context
  userId                String?
  tenantId              String?
  ipAddress             String?
  userAgent             String?
  
  // Metadata
  metadata              Json                  @default("{}")
  timestamp             DateTime              @default(now())
  
  // Relations
  user                  User?                 @relation("AuditUser", fields: [userId], references: [id])
  tenant                Tenant?               @relation("AuditTenant", fields: [tenantId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([tenantId])
  @@index([timestamp])
  
  @@map("notification_audit_logs")
}

// ============================================================================
// NOTIFICATION RULES & AUTOMATION
// ============================================================================

model NotificationRule {
  id                    String                @id @default(cuid())
  
  // Rule Information
  name                  String
  description           String?
  isActive              Boolean               @default(true)
  
  // Trigger Configuration
  eventType             String                // Domain event type
  conditions            Json                  @default("{}") // Conditions to match
  
  // Action Configuration
  notificationType      NotificationType
  channels              NotificationChannel[]
  priority              NotificationPriority  @default(MEDIUM)
  
  // Template & Content
  templateOverrides     Json?                 // Template variable overrides
  
  // Tenant Context
  tenantId              String?
  
  // Execution Stats
  executionCount        Int                   @default(0)
  lastExecutedAt        DateTime?
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("RuleTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator               User                  @relation("RuleCreator", fields: [createdBy], references: [id])
  
  @@index([eventType, isActive])
  @@index([tenantId, isActive])
  
  @@map("notification_rules")
}

// ============================================================================
// PROVIDER CONFIGURATION
// ============================================================================

model NotificationProvider {
  id                    String                @id @default(cuid())
  
  // Provider Information
  name                  String
  type                  NotificationChannel
  provider              String                // SES, SENDGRID, TWILIO, FCM, etc.
  
  // Configuration
  config                Json                  @default("{}")
  credentials           Json                  @default("{}") // Encrypted
  
  // Status & Health
  isActive              Boolean               @default(true)
  isDefault             Boolean               @default(false)
  priority              Int                   @default(0)
  
  // Rate Limits
  rateLimit             Json?                 // Provider-specific rate limits
  
  // Health Monitoring
  lastHealthCheck       DateTime?
  healthStatus          String?               // HEALTHY, DEGRADED, UNHEALTHY
  
  // Tenant Context
  tenantId              String?
  
  // Audit
  createdBy             String
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  // Relations
  tenant                Tenant?               @relation("ProviderTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator               User                  @relation("ProviderCreator", fields: [createdBy], references: [id])
  
  @@unique([name, type, tenantId])
  @@index([type, isActive])
  @@index([tenantId, type])
  
  @@map("notification_providers")
}

model Banner {
  id          String    @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  position    String
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  targetRules Json?     @default("{}")
  clickCount  Int       @default(0)
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  creator     User      @relation(fields: [createdBy], references: [id])

  @@map("banners")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String
  status      String   @default("DRAFT")
  startDate   DateTime
  endDate     DateTime
  budget      Float?
  targetRules Json?    @default("{}")
  metrics     Json?    @default("{}")
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  creator     User     @relation(fields: [createdBy], references: [id])

  @@map("campaigns")
}

model Job {
  id           String        @id @default(cuid())
  title        String
  description  String
  department   String
  location     String
  type         String
  experience   String
  salary       String?
  requirements String[]
  benefits     String[]
  status       String        @default("ACTIVE")
  postedBy     String
  postedAt     DateTime      @default(now())
  closesAt     DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  applications Application[]
  poster       User          @relation(fields: [postedBy], references: [id])

  @@map("jobs")
}

model Application {
  id          String    @id @default(cuid())
  jobId       String
  userId      String?
  email       String
  name        String
  phone       String?
  resumeUrl   String
  coverLetter String?
  status      String    @default("SUBMITTED")
  reviewedBy  String?
  reviewedAt  DateTime?
  notes       String?
  appliedAt   DateTime  @default(now())
  job         Job       @relation(fields: [jobId], references: [id])
  reviewer    User?     @relation("ApplicationReviewer", fields: [reviewedBy], references: [id])
  user        User?     @relation(fields: [userId], references: [id])

  @@map("applications")
}

model FeatureFlag {
  id                String   @id @default(cuid())
  key               String   @unique
  name              String
  description       String?
  isEnabled         Boolean  @default(false)
  rolloutPercentage Int      @default(0)
  targetRules       Json?    @default("{}")
  environment       String   @default("production")
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  creator           User     @relation(fields: [createdBy], references: [id])

  @@map("feature_flags")
}

model SearchIndex {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  title      String
  content    String
  keywords   String[]
  metadata   Json     @default("{}")
  isActive   Boolean  @default(true)
  updatedAt  DateTime @updatedAt

  @@unique([entityType, entityId])
  @@map("search_index")
}

model Promotion {
  id                    String           @id @default(cuid())
  name                  String
  description           String?
  code                  String?          @unique
  type                  String
  scope                 String
  status                String           @default("DRAFT")
  discountValue         Decimal          @db.Decimal(10, 2)
  maxDiscountAmount     Decimal?         @db.Decimal(10, 2)
  minOrderAmount        Decimal?         @db.Decimal(10, 2)
  usageLimit            Int?
  usageLimitPerUser     Int?
  currentUsage          Int              @default(0)
  validFrom             DateTime
  validTo               DateTime?
  applicableCategories  String[]         @default([])
  applicableProducts    String[]         @default([])
  applicableSellers     String[]         @default([])
  applicableUsers       String[]         @default([])
  buyQuantity           Int?
  getQuantity           Int?
  getDiscountPercentage Decimal?         @db.Decimal(5, 2)
  bundleProducts        String[]         @default([])
  bundleMinQuantity     Int?
  priority              Int              @default(0)
  isStackable           Boolean          @default(false)
  createdBy             String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  usages                PromotionUsage[]
  appliedPromotions     AppliedPromotion[] // Enhanced relation

  @@map("promotions")
}

model PromotionUsage {
  id             String    @id @default(cuid())
  promotionId    String
  userId         String
  orderId        String
  discountAmount Decimal   @db.Decimal(10, 2)
  usedAt         DateTime  @default(now())
  promotion      Promotion @relation(fields: [promotionId], references: [id])

  @@map("promotion_usage")
}

// Applied promotions with detailed tracking
model AppliedPromotion {
  id                   String               @id @default(cuid())
  promotionId          String
  promotionCode        String
  promotionName        String
  
  // Application context
  cartId               String?
  cartItemId           String?              // For item-specific promotions
  orderId              String?              // When converted to order
  
  // Discount details
  discountType         PromotionType
  discountValue        Decimal              @db.Decimal(10, 2)
  discountAmount       Decimal              @db.Decimal(10, 2) // Calculated discount
  maxDiscountAmount    Decimal?             @db.Decimal(10, 2)
  
  // Metadata
  priority             Int                  @default(0) // For stacking order
  eligibilitySnapshot  Json                 @default("{}") // Snapshot of eligibility criteria
  appliedAt            DateTime             @default(now())
  appliedBy            String?              // User ID or 'SYSTEM'
  
  // Relations
  promotion            Promotion            @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  cart                 Cart?                @relation("CartPromotions", fields: [cartId], references: [id], onDelete: Cascade)
  cartItem             CartItem?            @relation("CartItemPromotions", fields: [cartItemId], references: [id], onDelete: Cascade)
  order                Order?               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([cartId])
  @@index([promotionId])
  @@index([orderId])
  @@index([appliedAt])
  
  @@map("applied_promotions")
}

// Enhanced inventory reservation system
model InventoryReservation {
  id                      String               @id @default(cuid())
  variantId               String
  quantity                Int
  
  // Reference to what created this reservation
  referenceType           ReservationType      // CART, ORDER, SYSTEM
  referenceId             String
  
  // Reservation management
  status                  ReservationStatus    @default(ACTIVE)
  priority                ReservationPriority  @default(CART)
  expiresAt               DateTime?            // null for permanent reservations
  
  // Hierarchy for reservation conversion
  parentReservationId     String?              // Original reservation (for conversions)
  convertedToReservationId String?             // New reservation (when converted)
  
  // Audit trail
  createdBy               String?
  releasedBy              String?
  releasedAt              DateTime?
  releaseReason           String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  
  // Relations
  variant                 ProductVariant       @relation(fields: [variantId], references: [id], onDelete: Cascade)
  parentReservation       InventoryReservation? @relation("ReservationHierarchy", fields: [parentReservationId], references: [id])
  childReservations       InventoryReservation[] @relation("ReservationHierarchy")
  
  @@index([variantId])
  @@index([referenceType, referenceId])
  @@index([status])
  @@index([expiresAt])
  @@index([priority])
  
  @@map("inventory_reservations")
}

// Price change history for cart items
model CartPriceHistory {
  id                   String               @id @default(cuid())
  cartItemId           String
  cartId               String
  oldUnitPrice         Decimal              @db.Decimal(10, 2)
  newUnitPrice         Decimal              @db.Decimal(10, 2)
  priceChangeReason    String?
  changedAt            DateTime             @default(now())
  
  // Relations
  cartItem             CartItem             @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  cart                 Cart                 @relation("CartPriceHistory", fields: [cartId], references: [id], onDelete: Cascade)
  
  @@index([cartItemId])
  @@index([cartId])
  @@index([changedAt])
  
  @@map("cart_price_history")
}

// Comprehensive audit log for cart operations
model CartAuditLog {
  id                   String               @id @default(cuid())
  cartId               String
  action               CartAction           // CREATED, ITEM_ADDED, ITEM_REMOVED, etc.
  actorId              String?
  actorType            ActorType            @default(USER)
  details              Json                 @default("{}")
  ipAddress            String?
  userAgent            String?
  occurredAt           DateTime             @default(now())
  
  // Relations
  cart                 Cart                 @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  @@index([cartId])
  @@index([actorId])
  @@index([occurredAt])
  @@index([action])
  
  @@map("cart_audit_logs")
}

model DomainEvent {
  id            String    @id @default(cuid())
  eventType     String
  aggregateId   String
  aggregateType String
  eventData     Json
  version       Int       @default(1)
  occurredAt    DateTime  @default(now())
  processedAt   DateTime?
  isProcessed   Boolean   @default(false)

  @@map("domain_events")
}

model Role {
  id              String           @id @default(cuid())
  name            String
  description     String?
  tenantId        String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([name, tenantId])
  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  resource        String
  action          String
  description     String?
  conditions      Json             @default("[]")
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  tenantId   String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, tenantId])
  @@map("user_roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Configuration {
  id          String   @id @default(cuid())
  key         String
  value       String
  type        String   @default("string")
  tenantId    String   @default("")
  environment String   @default("development")
  description String?
  isSecret    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, tenantId, environment])
  @@map("configurations")
}

model SagaInstance {
  id            String   @id @default(cuid())
  sagaType      String
  tenantId      String
  userId        String
  status        String
  data          Json
  stepResults   Json     @default("{}")
  currentStep   Int      @default(0)
  correlationId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("saga_instances")
}

model ProductReadModel {
  id          String   @id @default(cuid())
  tenantId    String
  sellerId    String
  name        String
  slug        String
  description String?
  status      String
  categoryId  String
  brandId     String?
  images      Json     @default("[]")
  variants    Json     @default("[]")
  pricing     Json     @default("{}")
  inventory   Json     @default("{}")
  ratings     Json     @default("{}")
  version     Int      @default(1)
  lastUpdated DateTime @default(now())

  @@unique([slug, tenantId])
  @@map("product_read_models")
}

model OrderReadModel {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  orderNumber String
  status      String
  totalAmount Decimal
  items       Json     @default("[]")
  shipping    Json     @default("{}")
  payment     Json     @default("{}")
  timeline    Json     @default("[]")
  version     Int      @default(1)
  lastUpdated DateTime @default(now())

  @@unique([orderNumber, tenantId])
  @@map("order_read_models")
}

model InventoryReadModel {
  id             String   @id @default(cuid())
  tenantId       String
  variantId      String
  productId      String
  sellerId       String
  totalStock     Int
  availableStock Int
  reservedStock  Int
  lowStockAlert  Boolean  @default(false)
  version        Int      @default(1)
  lastUpdated    DateTime @default(now())

  @@unique([variantId, tenantId])
  @@map("inventory_read_models")
}

model FailedProjection {
  id          String    @id @default(cuid())
  eventId     String
  eventType   String
  handlerName String
  error       String
  eventData   Json
  tenantId    String
  retryCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  lastRetryAt DateTime?

  @@map("failed_projections")
}

model ArchivedData {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  tableName  String
  data       Json
  tenantId   String
  archivedAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([archivedAt])
  @@map("archived_data")
}

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique
  name        String
  type        String
  permissions String[]
  tenantId    String
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// ================================
// MISSING MODELS FOR DOMAINS-BACKUP
// ================================

model AttributeValue {
  id          String   @id @default(cuid())
  attributeId String
  entityType  String   // PRODUCT, VARIANT, CATEGORY
  entityId    String
  value       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([attributeId, entityType, entityId])
  @@map("attribute_values")
}

model BrandRequest {
  id            String    @id @default(cuid())
  requesterId   String
  brandName     String
  brandSlug     String
  description   String?
  logoUrl       String?
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  type          String    @default("NEW")
  reviewedBy    String?
  handledBy     String?
  reviewedAt    DateTime?
  notes         String?
  idempotencyKey String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  requester     User      @relation("BrandRequestRequester", fields: [requesterId], references: [id])
  handledByUser User?     @relation("BrandRequestHandler", fields: [handledBy], references: [id])
  brand         Brand?    @relation("BrandRequestBrand", fields: [brandSlug], references: [slug])

  @@map("brand_requests")
}

model BrandAccess {
  id            String    @id @default(cuid())
  brandId       String
  sellerId      String
  permission    String    // Single permission instead of array
  permissions   String[]  @default([])
  isActive      Boolean   @default(true)
  grantedBy     String
  revokedBy     String?
  grantedAt     DateTime  @default(now())
  revokedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  brand         Brand     @relation("BrandAccessBrand", fields: [brandId], references: [id])
  seller        User      @relation("BrandAccessSeller", fields: [sellerId], references: [id])
  grantedByUser User      @relation("BrandAccessGranter", fields: [grantedBy], references: [id])
  revokedByUser User?     @relation("BrandAccessRevoker", fields: [revokedBy], references: [id])

  @@unique([brandId, sellerId])
  @@map("brand_access")
}

model BrandAuditLog {
  id        String   @id @default(cuid())
  brandId   String
  userId    String
  action    String
  changes   Json?
  oldValues Json?
  newValues Json?
  userRole  String?
  ipAddress String?
  userAgent String?
  reason    String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation("BrandAuditUser", fields: [userId], references: [id])
  brand     Brand    @relation("BrandAuditBrand", fields: [brandId], references: [id])

  @@map("brand_audit_logs")
}

model CategoryAuditLog {
  id          String    @id @default(cuid())
  categoryId  String
  userId      String
  action      String
  changes     Json?
  oldValues   Json?
  newValues   Json?
  oldPath     String?
  newPath     String?
  oldParentId String?
  newParentId String?
  userRole    String?
  ipAddress   String?
  userAgent   String?
  reason      String?
  metadata    Json?
  batchId     String?
  createdAt   DateTime  @default(now())
  user        User      @relation("CategoryAuditUser", fields: [userId], references: [id])
  category    Category  @relation("CategoryAuditCategory", fields: [categoryId], references: [id])

  @@map("category_audit_logs")
}

model InventoryLedger {
  id          String   @id @default(cuid())
  variantId   String
  type        String   // IN, OUT, ADJUSTMENT
  quantity    Int
  reason      String
  reference   String?
  metadata    Json?
  createdBy   String
  createdAt   DateTime @default(now())

  @@map("inventory_ledger")
}

model PaymentIntent {
  id                     String               @id @default(cuid())
  intentId               String               @unique
  orderId                String
  clientSecret           String?
  amount                 Decimal              @db.Decimal(10, 2)
  currency               String               @default("INR")
  status                 String               @default("CREATED")
  gatewayProvider        String
  gatewayIntentId        String
  allowedPaymentMethods  String[]             @default([])
  confirmationMethod     String               @default("AUTOMATIC")
  captureMethod          String               @default("AUTOMATIC")
  transferGroup          String?
  applicationFee         Decimal?             @db.Decimal(10, 2)
  description            String?
  expiresAt              DateTime?
  version                Int                  @default(1)
  metadata               Json?
  createdBy              String
  updatedBy              String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  deletedAt              DateTime?
  deletedBy              String?
  order                  Order                @relation("PaymentIntentOrder", fields: [orderId], references: [id])
  transactions           PaymentTransaction[] @relation("PaymentIntentTransactions")
  attempts               PaymentAttempt[]     @relation("PaymentIntentAttempts")

  @@map("payment_intents")
}

model PaymentTransaction {
  id               String        @id @default(cuid())
  paymentIntentId  String
  transactionId    String        @unique
  amount           Decimal       @db.Decimal(10, 2)
  status           String        @default("PENDING")
  gatewayResponse  Json?
  processedAt      DateTime?
  createdAt        DateTime      @default(now())
  paymentIntent    PaymentIntent @relation("PaymentIntentTransactions", fields: [paymentIntentId], references: [id])

  @@map("payment_transactions")
}

model PaymentAttempt {
  id              String        @id @default(cuid())
  paymentIntentId String
  attemptNumber   Int
  status          String        @default("PENDING")
  errorCode       String?
  errorMessage    String?
  gatewayResponse Json?
  createdAt       DateTime      @default(now())
  paymentIntent   PaymentIntent @relation("PaymentIntentAttempts", fields: [paymentIntentId], references: [id])

  @@map("payment_attempts")
}

// Enums for Cart & Promotions System
enum CartStatus {
  ACTIVE
  EXPIRED
  CONVERTED
  ABANDONED
  MERGED
}

enum ReservationType {
  CART
  ORDER
  SYSTEM
}

enum ReservationStatus {
  ACTIVE
  EXPIRED
  CONVERTED
  RELEASED
}

enum ReservationPriority {
  CART
  ORDER
  SYSTEM
}

enum PromotionType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  BUY_X_GET_Y
  FREE_SHIPPING
  BUNDLE_DISCOUNT
}

enum CartAction {
  CREATED
  ITEM_ADDED
  ITEM_REMOVED
  ITEM_QUANTITY_UPDATED
  PROMOTION_APPLIED
  PROMOTION_REMOVED
  PRICE_UPDATED
  MERGED
  CONVERTED
  EXPIRED
  ABANDONED
}

enum ActorType {
  USER
  SYSTEM
  ADMIN
  GUEST
}