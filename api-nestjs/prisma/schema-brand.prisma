// Brand Domain Schema - Enterprise Edition
// Add this to your main schema.prisma file

enum BrandStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

enum BrandScope {
  GLOBAL
  SELLER_PRIVATE
  SELLER_SHARED
}

enum BrandPermission {
  VIEW
  USE
}

enum BrandRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum BrandRequestType {
  NEW_BRAND
  BRAND_UPDATE
  BRAND_REACTIVATION
}

model Brand {
  id          String      @id @default(cuid())
  name        String      @unique
  slug        String      @unique
  description String?
  logoUrl     String?
  websiteUrl  String?
  status      BrandStatus @default(DRAFT)
  
  // Enhanced ownership model
  scope       BrandScope  @default(SELLER_PRIVATE)
  isVerified  Boolean     @default(false) // Official/verified brands
  
  // Ownership
  ownerId     String      // Brand owner (creator)
  owner       User        @relation("BrandOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Metadata with validation rules
  metadata    Json?       // Flexible metadata storage
  
  // Category constraints
  allowedCategories    String[] // Category IDs where brand can be used
  restrictedCategories String[] // Category IDs where brand cannot be used
  
  // Brand access control
  brandAccess BrandAccess[]
  
  // Category relationships
  categories  BrandCategory[]
  
  // Products using this brand
  products    Product[]   @relation("ProductBrand")
  
  // Audit fields
  createdBy   String
  createdByUser User      @relation("BrandCreatedBy", fields: [createdBy], references: [id])
  updatedBy   String?
  updatedByUser User?     @relation("BrandUpdatedBy", fields: [updatedBy], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Enhanced soft delete
  deletedAt   DateTime?
  deletedBy   String?
  deletedByUser User?     @relation("BrandDeletedBy", fields: [deletedBy], references: [id])
  
  // Related requests
  requests    BrandRequest[]
  
  // Audit trail
  auditLogs   BrandAuditLog[]
  
  @@map("brands")
  @@index([ownerId])
  @@index([status])
  @@index([scope])
  @@index([slug])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([name]) // For search
}

// Brand access control - who can use which brands
model BrandAccess {
  id          String         @id @default(cuid())
  brandId     String
  sellerId    String
  permission  BrandPermission @default(VIEW)
  
  brand       Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  seller      User           @relation("BrandAccessSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  
  // Grant tracking
  grantedBy   String
  grantedByUser User         @relation("BrandAccessGranter", fields: [grantedBy], references: [id])
  grantedAt   DateTime       @default(now())
  
  // Revocation tracking
  revokedAt   DateTime?
  revokedBy   String?
  revokedByUser User?        @relation("BrandAccessRevoker", fields: [revokedBy], references: [id])
  
  @@unique([brandId, sellerId])
  @@map("brand_access")
  @@index([brandId])
  @@index([sellerId])
  @@index([permission])
  @@index([grantedAt])
}

model BrandRequest {
  id          String            @id @default(cuid())
  type        BrandRequestType  @default(NEW_BRAND)
  status      BrandRequestStatus @default(PENDING)
  
  // Idempotency support
  idempotencyKey String?        @unique
  
  // Request data
  brandName   String
  brandSlug   String
  description String?
  logoUrl     String?
  websiteUrl  String?
  categoryIds String[]          // JSON array of category IDs
  scope       BrandScope        @default(SELLER_PRIVATE)
  
  // Justification
  businessJustification String
  expectedUsage        String?
  
  // Existing brand (for updates/reactivation)
  brandId     String?
  brand       Brand?            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  // Requester
  requesterId String
  requester   User              @relation("BrandRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  
  // Admin handling
  handledBy   String?
  handledByUser User?           @relation("BrandRequestHandler", fields: [handledBy], references: [id])
  handledAt   DateTime?
  adminNotes  String?
  rejectionReason String?
  
  // Timestamps
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@map("brand_requests")
  @@index([requesterId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([idempotencyKey])
}

// Junction table for Brand-Category many-to-many relationship
model BrandCategory {
  id         String   @id @default(cuid())
  brandId    String
  categoryId String
  
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Metadata for the relationship
  isPrimary  Boolean  @default(false) // Primary category for the brand
  createdAt  DateTime @default(now())
  createdBy  String
  
  @@unique([brandId, categoryId])
  @@map("brand_categories")
  @@index([brandId])
  @@index([categoryId])
}

// Enhanced audit log for brand changes
model BrandAuditLog {
  id        String   @id @default(cuid())
  brandId   String
  brand     Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  action    String   // CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE, APPROVE, REJECT, etc.
  oldValues Json?    // Previous values
  newValues Json?    // New values
  changes   Json?    // Specific field changes
  
  // Actor
  userId    String
  user      User     @relation("BrandAuditUser", fields: [userId], references: [id])
  userRole  String   // Role at time of action
  
  // Context
  ipAddress String?
  userAgent String?
  reason    String?  // Reason for change
  
  createdAt DateTime @default(now())
  
  @@map("brand_audit_logs")
  @@index([brandId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Add to existing User model
model User {
  // ... existing fields ...
  
  // Enhanced brand relationships
  ownedBrands      Brand[]           @relation("BrandOwner")
  createdBrands    Brand[]           @relation("BrandCreatedBy")
  updatedBrands    Brand[]           @relation("BrandUpdatedBy")
  deletedBrands    Brand[]           @relation("BrandDeletedBy")
  
  // Brand access relationships
  brandAccess      BrandAccess[]     @relation("BrandAccessSeller")
  grantedAccess    BrandAccess[]     @relation("BrandAccessGranter")
  revokedAccess    BrandAccess[]     @relation("BrandAccessRevoker")
  
  // Brand requests
  brandRequests    BrandRequest[]    @relation("BrandRequester")
  handledRequests  BrandRequest[]    @relation("BrandRequestHandler")
  
  // Audit logs
  brandAuditLogs   BrandAuditLog[]   @relation("BrandAuditUser")
}

// Add to existing Category model
model Category {
  // ... existing fields ...
  
  // Brand relationships
  brands           BrandCategory[]
}

// Add to existing Product model
model Product {
  // ... existing fields ...
  
  // Brand relationship
  brandId          String?
  brand            Brand?            @relation("ProductBrand", fields: [brandId], references: [id], onDelete: SetNull)
}