name: Cleanup

on:
  schedule:
    # Run cleanup weekly on Sundays at 1 AM UTC
    - cron: '0 1 * * 0'
  workflow_dispatch:

jobs:
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            // Delete artifacts older than 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              
              if (createdAt < thirtyDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  console.log(`Deleted artifact: ${artifact.name} (${artifact.id})`);
                  deletedCount++;
                } catch (error) {
                  console.error(`Failed to delete artifact ${artifact.id}: ${error.message}`);
                }
              }
            }
            
            console.log(`Deleted ${deletedCount} old artifacts`);

  cleanup-packages:
    name: Cleanup Old Container Images
    runs-on: ubuntu-latest
    steps:
      - name: Delete old container images
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const packageName = 'api';
            
            try {
              // Get all package versions
              const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                package_type: 'container',
                package_name: packageName,
                org: owner,
                per_page: 100
              });
              
              // Keep the latest 10 versions and delete the rest
              const versionsToDelete = versions.data.slice(10);
              
              let deletedCount = 0;
              
              for (const version of versionsToDelete) {
                try {
                  await github.rest.packages.deletePackageVersionForOrg({
                    package_type: 'container',
                    package_name: packageName,
                    org: owner,
                    package_version_id: version.id
                  });
                  console.log(`Deleted package version: ${version.name} (${version.id})`);
                  deletedCount++;
                } catch (error) {
                  console.error(`Failed to delete package version ${version.id}: ${error.message}`);
                }
              }
              
              console.log(`Deleted ${deletedCount} old package versions`);
            } catch (error) {
              console.error(`Failed to cleanup packages: ${error.message}`);
              // Don't fail the job if package cleanup fails
            }

  cleanup-workflow-runs:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });
            
            let totalDeleted = 0;
            
            for (const workflow of workflows.data.workflows) {
              // Get workflow runs older than 90 days
              const ninetyDaysAgo = new Date();
              ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100,
                created: `<${ninetyDaysAgo.toISOString()}`
              });
              
              let deletedCount = 0;
              
              for (const run of runs.data.workflow_runs) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                  deletedCount++;
                } catch (error) {
                  console.error(`Failed to delete workflow run ${run.id}: ${error.message}`);
                }
              }
              
              if (deletedCount > 0) {
                console.log(`Deleted ${deletedCount} old runs for workflow: ${workflow.name}`);
                totalDeleted += deletedCount;
              }
            }
            
            console.log(`Total deleted workflow runs: ${totalDeleted}`);

  cleanup-caches:
    name: Cleanup Old Caches
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup caches
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              // Get all caches
              const caches = await github.rest.actions.getActionsCacheList({
                owner,
                repo,
                per_page: 100
              });
              
              // Delete caches older than 7 days
              const sevenDaysAgo = new Date();
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
              
              let deletedCount = 0;
              
              for (const cache of caches.data.actions_caches) {
                const createdAt = new Date(cache.created_at);
                
                if (createdAt < sevenDaysAgo) {
                  try {
                    await github.rest.actions.deleteActionsCacheById({
                      owner,
                      repo,
                      cache_id: cache.id
                    });
                    console.log(`Deleted cache: ${cache.key} (${cache.id})`);
                    deletedCount++;
                  } catch (error) {
                    console.error(`Failed to delete cache ${cache.id}: ${error.message}`);
                  }
                }
              }
              
              console.log(`Deleted ${deletedCount} old caches`);
            } catch (error) {
              console.error(`Failed to cleanup caches: ${error.message}`);
              // Don't fail the job if cache cleanup fails
            }

  cleanup-summary:
    name: Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-artifacts, cleanup-packages, cleanup-workflow-runs, cleanup-caches]
    if: always()
    steps:
      - name: Generate cleanup report
        run: |
          echo "# Cleanup Report" > cleanup-report.md
          echo "Generated on: $(date)" >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "## Cleanup Results" >> cleanup-report.md
          echo "- Artifacts Cleanup: ${{ needs.cleanup-artifacts.result }}" >> cleanup-report.md
          echo "- Packages Cleanup: ${{ needs.cleanup-packages.result }}" >> cleanup-report.md
          echo "- Workflow Runs Cleanup: ${{ needs.cleanup-workflow-runs.result }}" >> cleanup-report.md
          echo "- Caches Cleanup: ${{ needs.cleanup-caches.result }}" >> cleanup-report.md
          echo "" >> cleanup-report.md
          echo "## What was cleaned up" >> cleanup-report.md
          echo "- Artifacts older than 30 days" >> cleanup-report.md
          echo "- Container images (keeping latest 10 versions)" >> cleanup-report.md
          echo "- Workflow runs older than 90 days" >> cleanup-report.md
          echo "- Caches older than 7 days" >> cleanup-report.md

      - name: Upload cleanup report
        uses: actions/upload-artifact@v3
        with:
          name: cleanup-report
          path: cleanup-report.md
          retention-days: 30

      - name: Notify cleanup completion
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "ðŸ§¹ Weekly cleanup completed! Old artifacts, packages, and workflow runs have been removed."
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: env.SLACK_WEBHOOK != '' && success()