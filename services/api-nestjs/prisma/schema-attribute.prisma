// ============================================================================
// ATTRIBUTE SYSTEM SCHEMA
// ============================================================================
// Enterprise-grade attribute system for marketplace backend
// Supports inheritance, overrides, variants, localization, and performance optimization

// ============================================================================
// CORE ATTRIBUTE DEFINITION
// ============================================================================

model Attribute {
  id          String   @id @default(cuid()) @map("id")
  
  // Basic Information
  name        String   @map("name")
  slug        String   @map("slug")
  description String?  @map("description")
  
  // Data Type & Validation
  dataType    AttributeDataType @map("data_type")
  validation  Json?             @map("validation") // Validation rules as JSON
  
  // Behavior Flags
  isRequired     Boolean @default(false) @map("is_required")
  isVariant      Boolean @default(false) @map("is_variant")      // Drives product variants
  isFilterable   Boolean @default(true)  @map("is_filterable")   // Can be used in search filters
  isSearchable   Boolean @default(false) @map("is_searchable")   // Indexed for full-text search
  isComparable   Boolean @default(false) @map("is_comparable")   // Can be used in product comparison
  
  // Display & Organization
  displayOrder   Int     @default(0)     @map("display_order")
  groupName      String? @map("group_name")                      // Logical grouping (e.g., "Physical", "Technical")
  helpText       String? @map("help_text")                      // User guidance
  placeholder    String? @map("placeholder")                    // Input placeholder
  
  // Visibility & Access
  visibility     AttributeVisibility @default(PUBLIC) @map("visibility")
  adminOnly      Boolean @default(false) @map("admin_only")     // Only admins can set values
  
  // Localization Support
  isLocalizable  Boolean @default(false) @map("is_localizable") // Supports multiple languages
  
  // System Fields
  status         AttributeStatus @default(ACTIVE) @map("status")
  createdBy      String          @map("created_by")
  updatedBy      String?         @map("updated_by")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  deletedAt      DateTime?       @map("deleted_at")
  
  // Relationships
  categoryAttributes CategoryAttribute[]
  attributeOptions   AttributeOption[]
  attributeValues    AttributeValue[]
  localizations      AttributeLocalization[]
  auditLogs          AttributeAuditLog[]
  
  // Indexes
  @@unique([slug])
  @@index([dataType])
  @@index([isVariant])
  @@index([isFilterable])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("attributes")
}

// ============================================================================
// ATTRIBUTE OPTIONS (for ENUM/SELECT types)
// ============================================================================

model AttributeOption {
  id          String   @id @default(cuid()) @map("id")
  attributeId String   @map("attribute_id")
  
  // Option Details
  value       String   @map("value")        // Internal value
  label       String   @map("label")        // Display label
  description String?  @map("description")
  color       String?  @map("color")        // For color swatches
  imageUrl    String?  @map("image_url")    // For visual options
  
  // Organization
  displayOrder Int     @default(0) @map("display_order")
  isDefault    Boolean @default(false) @map("is_default")
  
  // System Fields
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Relationships
  attribute         Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  attributeValues   AttributeValue[]
  localizations     AttributeOptionLocalization[]
  
  // Indexes
  @@unique([attributeId, value])
  @@index([attributeId, displayOrder])
  @@map("attribute_options")
}

// ============================================================================
// CATEGORY-ATTRIBUTE RELATIONSHIP (Inheritance & Overrides)
// ============================================================================

model CategoryAttribute {
  id         String   @id @default(cuid()) @map("id")
  categoryId String   @map("category_id")
  attributeId String  @map("attribute_id")
  
  // Inheritance Behavior
  inheritanceType AttributeInheritanceType @default(INHERITED) @map("inheritance_type")
  sourceId        String?                  @map("source_id")    // Source category for inherited attributes
  
  // Override Settings
  isRequired      Boolean? @map("is_required")      // Override global setting
  isVariant       Boolean? @map("is_variant")       // Override global setting
  isFilterable    Boolean? @map("is_filterable")    // Override global setting
  displayOrder    Int?     @map("display_order")   // Override global setting
  groupName       String?  @map("group_name")      // Override global setting
  
  // Validation Overrides
  validationOverride Json? @map("validation_override") // Category-specific validation rules
  
  // System Fields
  createdBy    String    @map("created_by")
  updatedBy    String?   @map("updated_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  // Relationships
  category  Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([categoryId, attributeId])
  @@index([categoryId])
  @@index([attributeId])
  @@index([inheritanceType])
  @@map("category_attributes")
}

// ============================================================================
// ATTRIBUTE VALUES (Product/Variant Values)
// ============================================================================

model AttributeValue {
  id          String   @id @default(cuid()) @map("id")
  
  // Reference
  entityType  AttributeEntityType @map("entity_type") // PRODUCT, VARIANT, etc.
  entityId    String              @map("entity_id")   // Product/Variant ID
  attributeId String              @map("attribute_id")
  
  // Value Storage (polymorphic)
  stringValue   String?   @map("string_value")
  numberValue   Decimal?  @map("number_value") @db.Decimal(15, 4)
  booleanValue  Boolean?  @map("boolean_value")
  dateValue     DateTime? @map("date_value")
  jsonValue     Json?     @map("json_value")
  optionId      String?   @map("option_id")    // For ENUM/SELECT types
  
  // Localization
  locale        String?   @default("en") @map("locale")
  
  // System Fields
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relationships
  attribute Attribute        @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  option    AttributeOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)
  
  // Constraints & Indexes
  @@unique([entityType, entityId, attributeId, locale])
  @@index([entityType, entityId])
  @@index([attributeId])
  @@index([stringValue])
  @@index([numberValue])
  @@index([booleanValue])
  @@index([dateValue])
  @@index([optionId])
  @@map("attribute_values")
}

// ============================================================================
// LOCALIZATION SUPPORT
// ============================================================================

model AttributeLocalization {
  id          String @id @default(cuid()) @map("id")
  attributeId String @map("attribute_id")
  locale      String @map("locale")
  
  // Localized Fields
  name        String  @map("name")
  description String? @map("description")
  helpText    String? @map("help_text")
  placeholder String? @map("placeholder")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relationships
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([attributeId, locale])
  @@map("attribute_localizations")
}

model AttributeOptionLocalization {
  id       String @id @default(cuid()) @map("id")
  optionId String @map("option_id")
  locale   String @map("locale")
  
  // Localized Fields
  label       String  @map("label")
  description String? @map("description")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relationships
  option AttributeOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([optionId, locale])
  @@map("attribute_option_localizations")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AttributeAuditLog {
  id          String   @id @default(cuid()) @map("id")
  attributeId String   @map("attribute_id")
  
  // Action Details
  action      String   @map("action")        // CREATE, UPDATE, DELETE, etc.
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  changes     Json?    @map("changes")
  
  // Context
  userId      String   @map("user_id")
  userRole    String   @map("user_role")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  reason      String?  @map("reason")
  metadata    Json?    @map("metadata")
  batchId     String?  @map("batch_id")
  
  // System Fields
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relationships
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([attributeId])
  @@index([action])
  @@index([userId])
  @@index([createdAt])
  @@index([batchId])
  @@map("attribute_audit_logs")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AttributeDataType {
  STRING      // Text input
  TEXT        // Textarea
  NUMBER      // Numeric input
  DECIMAL     // Decimal number
  BOOLEAN     // Checkbox/toggle
  DATE        // Date picker
  DATETIME    // Date + time picker
  EMAIL       // Email input
  URL         // URL input
  PHONE       // Phone number
  COLOR       // Color picker
  ENUM        // Single select dropdown
  MULTI_ENUM  // Multi-select dropdown
  JSON        // Complex structured data
  FILE        // File upload
  IMAGE       // Image upload
  RICH_TEXT   // Rich text editor
  
  @@map("attribute_data_type")
}

enum AttributeStatus {
  DRAFT       // Being created/edited
  ACTIVE      // Available for use
  DEPRECATED  // Still usable but discouraged
  ARCHIVED    // No longer usable
  
  @@map("attribute_status")
}

enum AttributeVisibility {
  PUBLIC      // Visible to all users
  INTERNAL    // Visible to sellers/admins only
  ADMIN_ONLY  // Visible to admins only
  
  @@map("attribute_visibility")
}

enum AttributeInheritanceType {
  INHERITED   // Inherited from parent category
  OVERRIDDEN  // Overridden in this category
  DIRECT      // Directly assigned to this category
  
  @@map("attribute_inheritance_type")
}

enum AttributeEntityType {
  PRODUCT     // Product-level attribute
  VARIANT     // Variant-level attribute
  CATEGORY    // Category-level attribute (for metadata)
  
  @@map("attribute_entity_type")
}

// ============================================================================
// PERFORMANCE INDEXES
// ============================================================================

// Additional composite indexes for performance
// These would be added to existing models:

// On Category model (if not already present):
// @@index([path, status])           // Tree traversal with status filter
// @@index([parentId, displayOrder]) // Sibling ordering

// On Product model (future):
// @@index([categoryId, status])     // Products by category
// @@index([brandId, status])        // Products by brand

// On ProductVariant model (future):
// @@index([productId, status])      // Variants by product