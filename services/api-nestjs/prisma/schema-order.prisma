// ================================
// ORDER SYSTEM SCHEMA
// ================================

model Order {
  id          String   @id @default(cuid())
  orderNumber String   @unique // Human-readable order number
  
  // Customer Information
  customerId  String
  
  // Order Status & Lifecycle
  status      String   @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  
  // Multi-seller Support
  isSplit     Boolean  @default(false) // True if order spans multiple sellers
  parentOrderId String? // For split orders, reference to parent
  
  // Pricing (Snapshot at order time)
  subtotal    Decimal  @db.Decimal(10, 2)
  taxAmount   Decimal  @db.Decimal(10, 2) @default(0)
  shippingAmount Decimal @db.Decimal(10, 2) @default(0)
  discountAmount Decimal @db.Decimal(10, 2) @default(0)
  totalAmount Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  
  // Addresses (Snapshot)
  shippingAddress Json
  billingAddress  Json
  
  // Fulfillment
  shippingMethod  String?
  trackingNumber  String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
  // Expiry & Timeouts
  expiresAt   DateTime? // Order expiry for payment
  confirmedAt DateTime? // When payment confirmed
  shippedAt   DateTime?
  deliveredAt DateTime?
  cancelledAt DateTime?
  
  // Metadata
  metadata    Json     @default("{}")
  notes       String?
  
  // Versioning for optimistic locking
  version     Int      @default(1)
  
  // System Fields
  createdBy   String
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  deletedBy   String?
  
  // Relations
  customer      User              @relation(fields: [customerId], references: [id])
  parentOrder   Order?            @relation("OrderSplit", fields: [parentOrderId], references: [id])
  childOrders   Order[]           @relation("OrderSplit")
  items         OrderItem[]
  payments      OrderPayment[]
  refunds       OrderRefund[]
  auditLogs     OrderAuditLog[]
  statusHistory OrderStatusHistory[]
  
  // Indexes
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([parentOrderId])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([customerId, status])
  @@index([customerId, createdAt])
  
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  
  // Product Information (Snapshot)
  variantId   String
  productId   String
  sellerId    String
  sku         String
  productName String
  variantName String?
  
  // Quantity & Pricing (Snapshot at order time)
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  
  // Inventory Integration
  reservationKey String? // Link to inventory reservation
  
  // Fulfillment Status
  status      String   @default("PENDING") // PENDING, RESERVED, CONFIRMED, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  
  // Refund Tracking
  refundedQuantity Int @default(0)
  refundedAmount   Decimal @db.Decimal(10, 2) @default(0)
  
  // Product Snapshot (Immutable)
  productSnapshot Json // Complete product/variant data at order time
  
  // Metadata
  metadata    Json     @default("{}")
  
  // System Fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant   ProductVariant  @relation(fields: [variantId], references: [id])
  product   Product         @relation(fields: [productId], references: [id])
  seller    User            @relation(fields: [sellerId], references: [id])
  refunds   OrderItemRefund[]
  
  // Indexes
  @@index([orderId])
  @@index([variantId])
  @@index([sellerId])
  @@index([status])
  @@index([reservationKey])
  @@index([orderId, sellerId]) // For multi-seller order splitting
  
  @@map("order_items")
}

model OrderPayment {
  id          String   @id @default(cuid())
  orderId     String
  
  // Payment Details
  paymentMethod String  // CREDIT_CARD, PAYPAL, STRIPE, etc.
  paymentIntentId String? // External payment system ID
  
  // Amount & Status
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED, REFUNDED
  
  // Payment Gateway Response
  gatewayResponse Json @default("{}")
  
  // Failure Handling
  failureReason String?
  retryCount    Int    @default(0)
  
  // Timestamps
  processedAt DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  
  // Metadata
  metadata    Json     @default("{}")
  
  // System Fields
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user    User  @relation(fields: [createdBy], references: [id])
  
  // Indexes
  @@index([orderId])
  @@index([status])
  @@index([paymentIntentId])
  @@index([createdAt])
  
  @@map("order_payments")
}

model OrderRefund {
  id          String   @id @default(cuid())
  orderId     String
  
  // Refund Details
  refundNumber String  @unique
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  reason      String
  
  // Status & Processing
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  
  // Payment Gateway Integration
  paymentRefundId String? // External refund ID
  gatewayResponse Json    @default("{}")
  
  // Timestamps
  processedAt DateTime?
  completedAt DateTime?
  failedAt    DateTime?
  
  // Metadata
  metadata    Json     @default("{}")
  
  // System Fields
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  order     Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [createdBy], references: [id])
  itemRefunds OrderItemRefund[]
  
  // Indexes
  @@index([orderId])
  @@index([status])
  @@index([refundNumber])
  @@index([createdAt])
  
  @@map("order_refunds")
}

model OrderItemRefund {
  id          String   @id @default(cuid())
  refundId    String
  orderItemId String
  
  // Refund Details
  quantity    Int
  amount      Decimal  @db.Decimal(10, 2)
  reason      String?
  
  // System Fields
  createdAt   DateTime @default(now())
  
  // Relations
  refund    OrderRefund @relation(fields: [refundId], references: [id], onDelete: Cascade)
  orderItem OrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([refundId])
  @@index([orderItemId])
  
  @@map("order_item_refunds")
}

model OrderStatusHistory {
  id          String   @id @default(cuid())
  orderId     String
  
  // Status Change
  fromStatus  String?
  toStatus    String
  reason      String?
  
  // System Fields
  changedBy   String
  changedAt   DateTime @default(now())
  
  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [changedBy], references: [id])
  
  // Indexes
  @@index([orderId])
  @@index([orderId, changedAt])
  
  @@map("order_status_history")
}

model OrderAuditLog {
  id          String   @id @default(cuid())
  orderId     String
  
  // Audit Details
  action      String   // CREATE, UPDATE, CANCEL, REFUND, SHIP, etc.
  userId      String
  
  // State Changes
  oldValues   Json?
  newValues   Json?
  
  // Context
  reason      String?
  metadata    Json     @default("{}")
  
  // System Fields
  createdAt   DateTime @default(now())
  
  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])
  
  // Indexes
  @@index([orderId])
  @@index([orderId, createdAt])
  @@index([action])
  @@index([userId])
  
  @@map("order_audit_logs")
}

// Order Processing Jobs for async operations
model OrderProcessingJob {
  id          String   @id @default(cuid())
  orderId     String
  type        String   // PAYMENT_PROCESSING, INVENTORY_RESERVATION, FULFILLMENT, CANCELLATION
  status      String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING
  
  // Job Configuration
  payload     Json     @default("{}")
  options     Json     @default("{}")
  
  // Retry Logic
  retryCount  Int      @default(0)
  maxRetries  Int      @default(3)
  nextRetryAt DateTime?
  
  // Results
  result      Json?
  errorMessage String?
  
  // System Fields
  createdBy   String
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [createdBy], references: [id])
  
  // Indexes
  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([nextRetryAt])
  @@index([createdAt])
  
  @@map("order_processing_jobs")
}