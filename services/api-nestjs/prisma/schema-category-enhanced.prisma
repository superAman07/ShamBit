// Category Domain Schema - Enterprise Persistence Layer
// Add this to your main schema.prisma file

enum CategoryStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
  REJECTED
}

enum CategoryVisibility {
  PUBLIC      // Visible to all users
  INTERNAL    // Visible to sellers only
  RESTRICTED  // Admin-only visibility
}

enum AttributeType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  MULTI_SELECT
  DATE
  URL
  EMAIL
  JSON
  FILE_URL
  COLOR
  DIMENSION
  WEIGHT
  CURRENCY
}

enum AttributeValidationRule {
  REQUIRED
  UNIQUE
  MIN_LENGTH
  MAX_LENGTH
  MIN_VALUE
  MAX_VALUE
  REGEX_PATTERN
  ALLOWED_VALUES
  FILE_TYPES
  MAX_FILE_SIZE
}

model Category {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  
  // Hybrid tree structure for optimal performance
  parentId    String?
  parent      Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Category[]       @relation("CategoryHierarchy")
  
  // Materialized path for efficient subtree queries
  path        String           @unique // e.g., "/electronics/computers/laptops"
  pathIds     String[]         // Array of ancestor IDs: ["root_id", "parent_id"]
  depth       Int              @default(0)
  
  // Cached tree statistics for performance
  childCount      Int          @default(0)      // Direct children count
  descendantCount Int          @default(0)      // All descendants count
  productCount    Int          @default(0)      // Products in this category
  
  // Category lifecycle and visibility
  status      CategoryStatus   @default(DRAFT)
  visibility  CategoryVisibility @default(PUBLIC)
  
  // SEO optimization fields
  seoTitle       String?       @db.VarChar(60)   // Optimal for search engines
  seoDescription String?       @db.VarChar(160)  // Optimal for search engines
  seoKeywords    String[]      // Array of keywords
  
  // Rich metadata support
  metadata       Json?         // Flexible metadata storage
  
  // Display and UI properties
  iconUrl        String?
  bannerUrl      String?
  displayOrder   Int          @default(0)
  isLeaf         Boolean      @default(true)    // Can contain products
  isFeatured     Boolean      @default(false)
  
  // Brand integration constraints
  allowedBrands     String[]   // Brand IDs allowed in this category
  restrictedBrands  String[]   // Brand IDs restricted from this category
  requiresBrand     Boolean    @default(false)  // Products must have a brand
  
  // Multi-tenant support (future-ready)
  tenantId       String?      // For multi-tenant deployments
  
  // Version control for concurrent updates
  version        Int          @default(1)      // Optimistic locking
  
  // Category attributes and inheritance
  attributes        CategoryAttribute[]
  inheritedAttributes CategoryAttributeInheritance[]
  
  // Relationships with other domains
  brandCategories   BrandCategory[] // From brand domain
  products          Product[]       // Products in this category
  
  // Comprehensive audit fields
  createdBy    String
  createdByUser User           @relation("CategoryCreatedBy", fields: [createdBy], references: [id])
  updatedBy    String?
  updatedByUser User?          @relation("CategoryUpdatedBy", fields: [updatedBy], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // Soft delete with full audit trail
  deletedAt    DateTime?
  deletedBy    String?
  deletedByUser User?          @relation("CategoryDeletedBy", fields: [deletedBy], references: [id])
  
  // Audit trail
  auditLogs    CategoryAuditLog[]
  
  @@map("categories")
  
  // Performance-optimized indexes
  @@index([parentId])                    // Tree traversal
  @@index([path])                        // Path-based queries
  @@index([pathIds])                     // Ancestor queries
  @@index([status])                      // Status filtering
  @@index([visibility])                  // Visibility filtering
  @@index([depth])                       // Level-based queries
  @@index([displayOrder])                // Sorting
  @@index([isLeaf])                      // Leaf category queries
  @@index([isFeatured])                  // Featured categories
  @@index([createdAt])                   // Temporal queries
  @@index([deletedAt])                   // Soft delete queries
  @@index([slug])                        // Slug lookups
  @@index([tenantId])                    // Multi-tenant support
  @@index([version])                     // Optimistic locking
  
  // Composite indexes for complex queries
  @@index([status, visibility])          // Active visible categories
  @@index([parentId, displayOrder])      // Ordered children
  @@index([path, status])                // Active subtrees
  @@index([tenantId, status, visibility]) // Multi-tenant active categories
  @@index([depth, status])               // Level-based active categories
  @@index([isLeaf, status])              // Active leaf categories
  @@index([pathIds, status])             // Ancestor-based active queries
}

model CategoryAttribute {
  id          String           @id @default(cuid())
  categoryId  String
  category    Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Attribute definition
  name        String           // e.g., "Color", "Size", "Material"
  slug        String           // e.g., "color", "size", "material"
  type        AttributeType
  description String?
  
  // Inheritance and behavior flags
  isRequired     Boolean       @default(false)
  isInheritable  Boolean       @default(true)
  isOverridable  Boolean       @default(true)
  isVariant      Boolean       @default(false) // Drives product variants
  isFilterable   Boolean       @default(true)  // Can be used in search filters
  isSearchable   Boolean       @default(false) // Included in search index
  
  // Type-specific configuration
  defaultValue   String?       // Default value for the attribute
  allowedValues  String[]      // For SELECT/MULTI_SELECT types
  validationRules Json?        // Type-specific validation rules
  
  // Display and UI properties
  displayOrder   Int          @default(0)
  displayName    String?      // Human-readable name
  helpText       String?      // Help text for sellers
  placeholder    String?      // Input placeholder
  
  // Inheritance tracking
  inheritedFrom  String?      // Category ID this attribute was inherited from
  overriddenAt   String?      // Category ID where this was overridden
  
  // Version control
  version        Int          @default(1)
  
  // Audit fields
  createdBy      String
  createdByUser  User         @relation("CategoryAttributeCreatedBy", fields: [createdBy], references: [id])
  updatedBy      String?
  updatedByUser  User?        @relation("CategoryAttributeUpdatedBy", fields: [updatedBy], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  // Relationships
  inheritanceRules CategoryAttributeInheritance[]
  
  @@unique([categoryId, slug])
  @@map("category_attributes")
  
  // Performance indexes
  @@index([categoryId])
  @@index([type])
  @@index([isRequired])
  @@index([isVariant])
  @@index([isFilterable])
  @@index([displayOrder])
  @@index([inheritedFrom])
  @@index([version])
  
  // Composite indexes
  @@index([categoryId, displayOrder])
  @@index([type, isFilterable])
  @@index([isVariant, isRequired])
}

// Tracks attribute inheritance relationships for efficient queries
model CategoryAttributeInheritance {
  id                String            @id @default(cuid())
  
  // Source attribute (parent)
  sourceAttributeId String
  sourceAttribute   CategoryAttribute @relation(fields: [sourceAttributeId], references: [id], onDelete: Cascade)
  
  // Target category (child)
  targetCategoryId  String
  targetCategory    Category          @relation(fields: [targetCategoryId], references: [id], onDelete: Cascade)
  
  // Inheritance properties
  isActive          Boolean           @default(true)
  isOverridden      Boolean           @default(false)
  overriddenValues  Json?             // Values that were overridden
  
  // Version control
  version           Int               @default(1)
  
  // Audit
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@unique([sourceAttributeId, targetCategoryId])
  @@map("category_attribute_inheritance")
  
  // Performance indexes
  @@index([sourceAttributeId])
  @@index([targetCategoryId])
  @@index([isActive])
  @@index([isOverridden])
  @@index([version])
}

// Enhanced audit log for comprehensive tracking
model CategoryAuditLog {
  id        String   @id @default(cuid())
  categoryId String
  category  Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  action    String   // CREATE, UPDATE, DELETE, MOVE, ACTIVATE, ARCHIVE, etc.
  oldValues Json?    // Previous values
  newValues Json?    // New values
  changes   Json?    // Specific field changes
  
  // Tree operation specific fields
  oldPath   String?  // Previous path (for move operations)
  newPath   String?  // New path (for move operations)
  oldParentId String? // Previous parent (for move operations)
  newParentId String? // New parent (for move operations)
  
  // Actor information
  userId    String
  user      User     @relation("CategoryAuditUser", fields: [userId], references: [id])
  userRole  String   // Role at time of action
  
  // Context and metadata
  ipAddress String?
  userAgent String?
  reason    String?  // Reason for change
  metadata  Json?    // Additional context
  
  // Correlation for batch operations
  batchId   String?  // For grouping related operations
  
  createdAt DateTime @default(now())
  
  @@map("category_audit_logs")
  
  // Performance indexes
  @@index([categoryId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([batchId])
  
  // Composite indexes
  @@index([categoryId, action])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

// Materialized view for high-performance tree queries (optional)
model CategoryTreeView {
  id            String   @id @default(cuid())
  categoryId    String   @unique
  ancestorId    String
  depth         Int
  path          String
  
  // Cached category information for performance
  categoryName  String
  categorySlug  String
  categoryStatus CategoryStatus
  categoryVisibility CategoryVisibility
  
  // Tree statistics
  childCount    Int
  descendantCount Int
  productCount  Int
  
  // Timestamps for cache invalidation
  lastUpdated   DateTime @default(now())
  
  @@map("category_tree_view")
  
  // Optimized indexes for tree queries
  @@index([categoryId])
  @@index([ancestorId])
  @@index([depth])
  @@index([path])
  @@index([categoryStatus])
  @@index([lastUpdated])
  
  // Composite indexes
  @@index([ancestorId, depth])
  @@index([categoryStatus, categoryVisibility])
  @@index([path, categoryStatus])
}

// Category slug history for SEO and redirects
model CategorySlugHistory {
  id         String   @id @default(cuid())
  categoryId String
  oldSlug    String
  newSlug    String
  changedBy  String
  changedAt  DateTime @default(now())
  reason     String?
  
  @@map("category_slug_history")
  @@index([categoryId])
  @@index([oldSlug])
  @@index([newSlug])
  @@index([changedAt])
}