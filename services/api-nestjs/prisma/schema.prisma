generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id             String          @id @default(cuid())
  name           String
  slug           String          @unique
  type           String
  status         String          @default("ACTIVE")
  settings       Json            @default("{}")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  apiKeys        ApiKey[]
  tenantFeatures TenantFeature[]
  userTenants    UserTenant[]

  @@map("tenants")
}

model UserTenant {
  id       String   @id @default(cuid())
  userId   String
  tenantId String
  roles    String[] @default([])
  status   String   @default("ACTIVE")
  joinedAt DateTime @default(now())
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@map("user_tenants")
}

model Feature {
  id             String          @id @default(cuid())
  name           String          @unique
  description    String?
  isActive       Boolean         @default(true)
  tenantFeatures TenantFeature[]

  @@map("features")
}

model TenantFeature {
  id        String  @id @default(cuid())
  tenantId  String
  featureId String
  isEnabled Boolean @default(true)
  config    Json    @default("{}")
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureId])
  @@map("tenant_features")
}

model User {
  id                        String                   @id @default(cuid())
  email                     String                   @unique
  name                      String
  phone                     String?
  password                  String
  roles                     String[]                 @default(["BUYER"])
  status                    String                   @default("ACTIVE")
  isEmailVerified           Boolean                  @default(false)
  isPhoneVerified           Boolean                  @default(false)
  lastLoginAt               DateTime?
  deletedAt                 DateTime?
  deletedBy                 String?
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt
  addresses                 Address[]
  applicationsReviewed      Application[]            @relation("ApplicationReviewer")
  applications              Application[]
  attributesCreated         Attribute[]              @relation("AttributeCreator")
  attributesDeleted         Attribute[]              @relation("AttributeDeleter")
  attributesUpdated         Attribute[]              @relation("AttributeUpdater")
  auditLogsAsActor          AuditLog[]               @relation("AuditActor")
  bannersCreated            Banner[]
  campaignsCreated          Campaign[]
  carts                     Cart?
  categoryAttributesCreated CategoryAttribute[]      @relation("CategoryAttributeCreator")
  featureFlagsCreated       FeatureFlag[]
  inventoryReservations     InventoryReservation[]
  jobsPosted                Job[]
  mediaFiles                MediaFile[]
  notificationPreferences   NotificationPreference[]
  notifications             Notification[]
  orders                    Order[]
  reviewHelpful             ReviewHelpful[]
  reviewsModerated          Review[]                 @relation("ReviewModerator")
  reviews                   Review[]
  sellerProfile             SellerProfile?
  userRoles                 UserRole[]
  userTenants               UserTenant[]
  webhooksCreated           Webhook[]

  @@map("users")
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  type         String   @default("HOME")
  name         String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String
  postalCode   String
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@map("addresses")
}

model SellerProfile {
  id                String     @id @default(cuid())
  userId            String     @unique
  businessName      String
  businessType      String
  gstNumber         String?
  panNumber         String
  businessAddress   Json
  bankDetails       Json
  status            String     @default("DRAFT")
  verificationLevel String     @default("NONE")
  approvedAt        DateTime?
  approvedBy        String?
  rejectedAt        DateTime?
  rejectedBy        String?
  rejectionReason   String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  brands            Brand[]
  cartItems         CartItem[]
  products          Product[]
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("seller_profiles")
}

model Category {
  id          String              @id @default(cuid())
  name        String
  description String
  slug        String              @unique
  parentId    String?
  isActive    Boolean             @default(true)
  sortOrder   Int                 @default(0)
  imageUrl    String?
  level       Int                 @default(0)
  path        String
  pathIds     String[]            @default([])
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  parent      Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]          @relation("CategoryHierarchy")
  attributes  CategoryAttribute[]
  brands      CategoryBrand[]
  products    Product[]

  @@map("categories")
}

model Attribute {
  id               String                  @id @default(cuid())
  name             String
  slug             String                  @unique
  description      String?
  dataType         String
  inputType        String?
  isRequired       Boolean                 @default(false)
  isVariant        Boolean                 @default(false)
  isFilterable     Boolean                 @default(true)
  isSearchable     Boolean                 @default(false)
  isComparable     Boolean                 @default(false)
  displayOrder     Int                     @default(0)
  groupName        String?
  helpText         String?
  placeholder      String?
  visibility       String                  @default("PUBLIC")
  adminOnly        Boolean                 @default(false)
  isLocalizable    Boolean                 @default(false)
  status           String                  @default("DRAFT")
  createdBy        String
  updatedBy        String?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  deletedAt        DateTime?
  deletedBy        String?
  localizations    AttributeLocalization[]
  attributeOptions AttributeOption[]
  creator          User                    @relation("AttributeCreator", fields: [createdBy], references: [id])
  deleter          User?                   @relation("AttributeDeleter", fields: [deletedBy], references: [id])
  updater          User?                   @relation("AttributeUpdater", fields: [updatedBy], references: [id])
  productValues    ProductAttributeValue[]
  variantValues    VariantAttributeValue[]

  @@map("attributes")
}

model AttributeOption {
  id           String    @id @default(cuid())
  attributeId  String
  value        String
  label        String
  description  String?
  color        String?
  imageUrl     String?
  displayOrder Int       @default(0)
  isDefault    Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@map("attribute_options")
}

model AttributeLocalization {
  id          String    @id @default(cuid())
  attributeId String
  locale      String
  name        String
  description String?
  helpText    String?
  placeholder String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  attribute   Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([attributeId, locale])
  @@map("attribute_localizations")
}

model CategoryAttribute {
  id              String   @id @default(cuid())
  categoryId      String
  name            String
  slug            String
  type            String
  description     String?
  isRequired      Boolean  @default(false)
  isInheritable   Boolean  @default(false)
  isOverridable   Boolean  @default(false)
  isVariant       Boolean  @default(false)
  isFilterable    Boolean  @default(false)
  isSearchable    Boolean  @default(false)
  defaultValue    String?
  allowedValues   String[]
  validationRules Json?
  displayOrder    Int      @default(0)
  displayName     String?
  helpText        String?
  placeholder     String?
  inheritedFrom   String?
  overriddenAt    String?
  createdBy       String
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  version         Int      @default(1)
  category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdByUser   User     @relation("CategoryAttributeCreator", fields: [createdBy], references: [id])

  @@unique([categoryId, slug])
  @@map("category_attributes")
}

model CategoryAttributeInheritance {
  id                String   @id @default(cuid())
  sourceAttributeId String
  targetCategoryId  String
  isActive          Boolean  @default(true)
  isOverridden      Boolean  @default(false)
  overriddenValues  Json?
  version           Int      @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([sourceAttributeId, targetCategoryId])
  @@map("category_attribute_inheritance")
}

model Brand {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?
  logoUrl     String?
  isActive    Boolean         @default(true)
  sellerId    String?
  status      String          @default("PENDING")
  approvedAt  DateTime?
  approvedBy  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  seller      SellerProfile?  @relation(fields: [sellerId], references: [id])
  categories  CategoryBrand[]
  products    Product[]

  @@map("brands")
}

model CategoryBrand {
  categoryId String
  brandId    String
  createdAt  DateTime @default(now())
  brand      Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([categoryId, brandId])
  @@map("category_brands")
}

model Product {
  id               String                  @id @default(cuid())
  name             String
  description      String
  slug             String                  @unique
  categoryId       String
  brandId          String?
  sellerId         String
  status           String                  @default("DRAFT")
  isActive         Boolean                 @default(false)
  isFeatured       Boolean                 @default(false)
  hasVariants      Boolean                 @default(false)
  moderationStatus String?
  approvedAt       DateTime?
  approvedBy       String?
  rejectedAt       DateTime?
  rejectedBy       String?
  rejectionReason  String?
  updatedBy        String?
  deletedAt        DateTime?
  deletedBy        String?
  version          Int                     @default(1)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  attributeValues  ProductAttributeValue[]
  images           ProductImage[]
  variants         ProductVariant[]
  brand            Brand?                  @relation(fields: [brandId], references: [id])
  category         Category                @relation(fields: [categoryId], references: [id])
  seller           SellerProfile           @relation(fields: [sellerId], references: [id])

  @@map("products")
}

model ProductAttributeValue {
  id           String    @id @default(cuid())
  productId    String
  attributeId  String
  value        Json
  stringValue  String?
  numberValue  Float?
  booleanValue Boolean?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  attribute    Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@map("product_attribute_values")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id              String                  @id @default(cuid())
  productId       String
  sku             String                  @unique
  variantKey      String
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  cartItems       CartItem[]
  orderItems      OrderItem[]
  product         Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValues VariantAttributeValue[]
  images          VariantImage[]
  inventory       VariantInventory?
  pricing         VariantPricing?

  @@unique([productId, variantKey])
  @@map("product_variants")
}

model VariantAttributeValue {
  id          String         @id @default(cuid())
  variantId   String
  attributeId String
  value       Json
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  attribute   Attribute      @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
  @@map("variant_attribute_values")
}

model VariantImage {
  id        String         @id @default(cuid())
  variantId String
  url       String
  altText   String?
  sortOrder Int            @default(0)
  createdAt DateTime       @default(now())
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_images")
}

model VariantPricing {
  id           String         @id @default(cuid())
  variantId    String         @unique
  mrp          Decimal        @db.Decimal(10, 2)
  sellingPrice Decimal        @db.Decimal(10, 2)
  costPrice    Decimal?       @db.Decimal(10, 2)
  discount     Decimal?       @db.Decimal(5, 2)
  isActive     Boolean        @default(true)
  validFrom    DateTime       @default(now())
  validTo      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  variant      ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_pricing")
}

model VariantInventory {
  id                String                 @id @default(cuid())
  variantId         String                 @unique
  quantity          Int                    @default(0)
  reservedQuantity  Int                    @default(0)
  availableQuantity Int                    @default(0)
  lowStockThreshold Int                    @default(5)
  isTrackingEnabled Boolean                @default(true)
  lastUpdatedAt     DateTime               @default(now())
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  movements         InventoryMovement[]
  reservations      InventoryReservation[]
  variant           ProductVariant         @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_inventory")
}

model InventoryReservation {
  id             String           @id @default(cuid())
  inventoryId    String
  orderId        String?
  quantity       Int
  reservationKey String           @unique
  expiresAt      DateTime
  isExpired      Boolean          @default(false)
  status         String           @default("ACTIVE")
  referenceType  String
  referenceId    String
  metadata       Json             @default("{}")
  createdBy      String
  updatedBy      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User             @relation(fields: [createdBy], references: [id])
  inventory      VariantInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  order          Order?           @relation(fields: [orderId], references: [id])

  @@index([inventoryId])
  @@index([reservationKey])
  @@index([expiresAt])
  @@index([status])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("inventory_reservations")
}

model InventoryMovement {
  id          String           @id @default(cuid())
  inventoryId String
  type        String
  quantity    Int
  reason      String
  reference   String?
  createdBy   String
  createdAt   DateTime         @default(now())
  inventory   VariantInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@map("inventory_movements")
}

model CommissionRule {
  id          String    @id @default(cuid())
  name        String
  type        String
  entityId    String
  rate        Decimal   @db.Decimal(5, 2)
  fixedAmount Decimal?  @db.Decimal(10, 2)
  minAmount   Decimal?  @db.Decimal(10, 2)
  maxAmount   Decimal?  @db.Decimal(10, 2)
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  validFrom   DateTime  @default(now())
  validTo     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("commission_rules")
}

model Order {
  id                String                 @id @default(cuid())
  orderNumber       String                 @unique
  userId            String
  status            String                 @default("PENDING")
  totalAmount       Decimal                @db.Decimal(10, 2)
  discountAmount    Decimal                @default(0) @db.Decimal(10, 2)
  taxAmount         Decimal                @default(0) @db.Decimal(10, 2)
  shippingAmount    Decimal                @default(0) @db.Decimal(10, 2)
  finalAmount       Decimal                @db.Decimal(10, 2)
  paymentStatus     String                 @default("PENDING")
  shippingAddressId String
  billingAddressId  String?
  notes             String?
  cancelledAt       DateTime?
  cancelReason      String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  reservations      InventoryReservation[]
  items             OrderItem[]
  shippingAddress   Address                @relation(fields: [shippingAddressId], references: [id])
  user              User                   @relation(fields: [userId], references: [id])
  payments          Payment[]
  reviews           Review[]
  shipments         Shipment[]

  @@map("orders")
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  variantId        String
  quantity         Int
  unitPrice        Decimal        @db.Decimal(10, 2)
  totalPrice       Decimal        @db.Decimal(10, 2)
  discountAmount   Decimal        @default(0) @db.Decimal(10, 2)
  taxAmount        Decimal        @default(0) @db.Decimal(10, 2)
  commissionRate   Decimal        @db.Decimal(5, 2)
  commissionAmount Decimal        @db.Decimal(10, 2)
  productSnapshot  Json
  variantSnapshot  Json
  pricingSnapshot  Json
  createdAt        DateTime       @default(now())
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant          ProductVariant @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

model Payment {
  id              String    @id @default(cuid())
  orderId         String
  paymentIntentId String    @unique
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("INR")
  status          String    @default("PENDING")
  paymentMethod   String
  gatewayResponse Json?
  failureReason   String?
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Shipment {
  id                String             @id @default(cuid())
  orderId           String
  trackingNumber    String             @unique
  carrier           String
  status            String             @default("PENDING")
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  tracking          ShipmentTracking[]
  order             Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipments")
}

model ShipmentTracking {
  id          String   @id @default(cuid())
  shipmentId  String
  status      String
  location    String?
  description String
  timestamp   DateTime
  createdAt   DateTime @default(now())
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_tracking")
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  changes    Json?
  actorId    String?
  actorType  String   @default("USER")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  actor      User?    @relation("AuditActor", fields: [actorId], references: [id])

  @@map("audit_logs")
}

model Cart {
  id                String     @id @default(cuid())
  userId            String?    @unique
  sessionId         String?    @unique
  subtotal          Float      @default(0)
  discountAmount    Float      @default(0)
  totalAmount       Float      @default(0)
  appliedPromotions String[]   @default([])
  expiresAt         DateTime?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  items             CartItem[]
  user              User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id            String         @id @default(cuid())
  cartId        String
  variantId     String
  sellerId      String
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  isAvailable   Boolean        @default(true)
  reservationId String?
  addedAt       DateTime       @default(now())
  cart          Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  seller        SellerProfile  @relation(fields: [sellerId], references: [id])
  variant       ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId, sellerId])
  @@map("cart_items")
}

model MediaFile {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  cdnUrl       String?
  type         String
  entityId     String?
  entityType   String?
  metadata     Json     @default("{}")
  status       String   @default("PENDING")
  uploadedBy   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  uploader     User     @relation(fields: [uploadedBy], references: [id])

  @@map("media_files")
}

model Review {
  id                 String          @id @default(cuid())
  userId             String
  type               String
  entityId           String
  orderId            String?
  rating             Int
  title              String?
  comment            String?
  images             String[]        @default([])
  status             String          @default("PENDING")
  isVerifiedPurchase Boolean         @default(false)
  helpfulCount       Int             @default(0)
  reportCount        Int             @default(0)
  moderatedBy        String?
  moderatedAt        DateTime?
  moderationReason   String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  helpful            ReviewHelpful[]
  moderator          User?           @relation("ReviewModerator", fields: [moderatedBy], references: [id])
  order              Order?          @relation(fields: [orderId], references: [id])
  user               User            @relation(fields: [userId], references: [id])

  @@unique([userId, type, entityId])
  @@map("reviews")
}

model ReviewHelpful {
  id        String  @id @default(cuid())
  reviewId  String
  userId    String
  isHelpful Boolean
  review    Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
  @@map("review_helpful")
}

model AggregatedRating {
  id            String   @id @default(cuid())
  entityType    String
  entityId      String
  averageRating Float    @default(0)
  totalReviews  Int      @default(0)
  rating1Count  Int      @default(0)
  rating2Count  Int      @default(0)
  rating3Count  Int      @default(0)
  rating4Count  Int      @default(0)
  rating5Count  Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@unique([entityType, entityId])
  @@map("aggregated_ratings")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  channel   String
  priority  String    @default("MEDIUM")
  title     String
  message   String
  data      Json?     @default("{}")
  isRead    Boolean   @default(false)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model NotificationPreference {
  id     String  @id @default(cuid())
  userId String
  type   String
  email  Boolean @default(true)
  push   Boolean @default(true)
  inApp  Boolean @default(true)
  sms    Boolean @default(false)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("notification_preferences")
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  type      String   @unique
  channel   String
  subject   String?
  title     String
  message   String
  variables String[] @default([])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_templates")
}

model Banner {
  id          String    @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?
  position    String
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  targetRules Json?     @default("{}")
  clickCount  Int       @default(0)
  createdBy   String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  creator     User      @relation(fields: [createdBy], references: [id])

  @@map("banners")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String
  status      String   @default("DRAFT")
  startDate   DateTime
  endDate     DateTime
  budget      Float?
  targetRules Json?    @default("{}")
  metrics     Json?    @default("{}")
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  creator     User     @relation(fields: [createdBy], references: [id])

  @@map("campaigns")
}

model Job {
  id           String        @id @default(cuid())
  title        String
  description  String
  department   String
  location     String
  type         String
  experience   String
  salary       String?
  requirements String[]
  benefits     String[]
  status       String        @default("ACTIVE")
  postedBy     String
  postedAt     DateTime      @default(now())
  closesAt     DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  applications Application[]
  poster       User          @relation(fields: [postedBy], references: [id])

  @@map("jobs")
}

model Application {
  id          String    @id @default(cuid())
  jobId       String
  userId      String?
  email       String
  name        String
  phone       String?
  resumeUrl   String
  coverLetter String?
  status      String    @default("SUBMITTED")
  reviewedBy  String?
  reviewedAt  DateTime?
  notes       String?
  appliedAt   DateTime  @default(now())
  job         Job       @relation(fields: [jobId], references: [id])
  reviewer    User?     @relation("ApplicationReviewer", fields: [reviewedBy], references: [id])
  user        User?     @relation(fields: [userId], references: [id])

  @@map("applications")
}

model FeatureFlag {
  id                String   @id @default(cuid())
  key               String   @unique
  name              String
  description       String?
  isEnabled         Boolean  @default(false)
  rolloutPercentage Int      @default(0)
  targetRules       Json?    @default("{}")
  environment       String   @default("production")
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  creator           User     @relation(fields: [createdBy], references: [id])

  @@map("feature_flags")
}

model Webhook {
  id         String            @id @default(cuid())
  name       String
  url        String
  events     String[]
  secret     String?
  isActive   Boolean           @default(true)
  retryCount Int               @default(3)
  timeout    Int               @default(30000)
  headers    Json?             @default("{}")
  createdBy  String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deliveries WebhookDelivery[]
  creator    User              @relation(fields: [createdBy], references: [id])

  @@map("webhooks")
}

model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  eventType    String
  payload      Json
  status       String    @default("PENDING")
  responseCode Int?
  responseBody String?
  attempts     Int       @default(0)
  nextRetryAt  DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime  @default(now())
  webhook      Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
}

model SearchIndex {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  title      String
  content    String
  keywords   String[]
  metadata   Json     @default("{}")
  isActive   Boolean  @default(true)
  updatedAt  DateTime @updatedAt

  @@unique([entityType, entityId])
  @@map("search_index")
}

model Promotion {
  id                    String           @id @default(cuid())
  name                  String
  description           String?
  code                  String?          @unique
  type                  String
  scope                 String
  status                String           @default("DRAFT")
  discountValue         Decimal          @db.Decimal(10, 2)
  maxDiscountAmount     Decimal?         @db.Decimal(10, 2)
  minOrderAmount        Decimal?         @db.Decimal(10, 2)
  usageLimit            Int?
  usageLimitPerUser     Int?
  currentUsage          Int              @default(0)
  validFrom             DateTime
  validTo               DateTime?
  applicableCategories  String[]         @default([])
  applicableProducts    String[]         @default([])
  applicableSellers     String[]         @default([])
  applicableUsers       String[]         @default([])
  buyQuantity           Int?
  getQuantity           Int?
  getDiscountPercentage Decimal?         @db.Decimal(5, 2)
  bundleProducts        String[]         @default([])
  bundleMinQuantity     Int?
  priority              Int              @default(0)
  isStackable           Boolean          @default(false)
  createdBy             String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  usages                PromotionUsage[]

  @@map("promotions")
}

model PromotionUsage {
  id             String    @id @default(cuid())
  promotionId    String
  userId         String
  orderId        String
  discountAmount Decimal   @db.Decimal(10, 2)
  usedAt         DateTime  @default(now())
  promotion      Promotion @relation(fields: [promotionId], references: [id])

  @@map("promotion_usage")
}

model DomainEvent {
  id            String    @id @default(cuid())
  eventType     String
  aggregateId   String
  aggregateType String
  eventData     Json
  version       Int       @default(1)
  occurredAt    DateTime  @default(now())
  processedAt   DateTime?
  isProcessed   Boolean   @default(false)

  @@map("domain_events")
}

model Role {
  id              String           @id @default(cuid())
  name            String
  description     String?
  tenantId        String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@unique([name, tenantId])
  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  resource        String
  action          String
  description     String?
  conditions      Json             @default("[]")
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  tenantId   String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, tenantId])
  @@map("user_roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model Configuration {
  id          String   @id @default(cuid())
  key         String
  value       String
  type        String   @default("string")
  tenantId    String   @default("")
  environment String   @default("development")
  description String?
  isSecret    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, tenantId, environment])
  @@map("configurations")
}

model SagaInstance {
  id            String   @id @default(cuid())
  sagaType      String
  tenantId      String
  userId        String
  status        String
  data          Json
  stepResults   Json     @default("{}")
  currentStep   Int      @default(0)
  correlationId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("saga_instances")
}

model ProductReadModel {
  id          String   @id @default(cuid())
  tenantId    String
  sellerId    String
  name        String
  slug        String
  description String?
  status      String
  categoryId  String
  brandId     String?
  images      Json     @default("[]")
  variants    Json     @default("[]")
  pricing     Json     @default("{}")
  inventory   Json     @default("{}")
  ratings     Json     @default("{}")
  version     Int      @default(1)
  lastUpdated DateTime @default(now())

  @@unique([slug, tenantId])
  @@map("product_read_models")
}

model OrderReadModel {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  orderNumber String
  status      String
  totalAmount Decimal
  items       Json     @default("[]")
  shipping    Json     @default("{}")
  payment     Json     @default("{}")
  timeline    Json     @default("[]")
  version     Int      @default(1)
  lastUpdated DateTime @default(now())

  @@unique([orderNumber, tenantId])
  @@map("order_read_models")
}

model InventoryReadModel {
  id             String   @id @default(cuid())
  tenantId       String
  variantId      String
  productId      String
  sellerId       String
  totalStock     Int
  availableStock Int
  reservedStock  Int
  lowStockAlert  Boolean  @default(false)
  version        Int      @default(1)
  lastUpdated    DateTime @default(now())

  @@unique([variantId, tenantId])
  @@map("inventory_read_models")
}

model FailedProjection {
  id          String    @id @default(cuid())
  eventId     String
  eventType   String
  handlerName String
  error       String
  eventData   Json
  tenantId    String
  retryCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  lastRetryAt DateTime?

  @@map("failed_projections")
}

model ArchivedData {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  tableName  String
  data       Json
  tenantId   String
  archivedAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([archivedAt])
  @@map("archived_data")
}

model ApiKey {
  id          String    @id @default(cuid())
  key         String    @unique
  name        String
  type        String
  permissions String[]
  tenantId    String
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  createdBy   String
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}
