// Category Domain Schema - Enterprise Edition
// Add this to your main schema.prisma file

enum CategoryStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
  REJECTED
}

enum CategoryVisibility {
  PUBLIC      // Visible to all users
  INTERNAL    // Visible to sellers only
  RESTRICTED  // Admin-only visibility
}

enum AttributeType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  MULTI_SELECT
  DATE
  URL
  EMAIL
  JSON
  FILE_URL
  COLOR
  DIMENSION
  WEIGHT
  CURRENCY
}

enum AttributeValidationRule {
  REQUIRED
  UNIQUE
  MIN_LENGTH
  MAX_LENGTH
  MIN_VALUE
  MAX_VALUE
  REGEX_PATTERN
  ALLOWED_VALUES
  FILE_TYPES
  MAX_FILE_SIZE
}

model Category {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  
  // Tree structure - Hybrid approach
  parentId    String?
  parent      Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Category[]       @relation("CategoryHierarchy")
  
  // Materialized path for efficient queries
  path        String           @unique // e.g., "/electronics/computers/laptops"
  pathIds     String[]         // Array of ancestor IDs for efficient queries
  depth       Int              @default(0)
  
  // Tree statistics (cached for performance)
  childCount      Int          @default(0)
  descendantCount Int          @default(0)
  productCount    Int          @default(0)
  
  // Category properties
  status      CategoryStatus   @default(DRAFT)
  visibility  CategoryVisibility @default(PUBLIC)
  
  // SEO and metadata
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]
  metadata       Json?         // Flexible metadata storage
  
  // Display properties
  iconUrl        String?
  bannerUrl      String?
  displayOrder   Int          @default(0)
  isLeaf         Boolean      @default(true) // Can have products
  isFeatured     Boolean      @default(false)
  
  // Brand constraints
  allowedBrands     String[]   // Brand IDs allowed in this category
  restrictedBrands  String[]   // Brand IDs restricted from this category
  requiresBrand     Boolean    @default(false) // Products must have a brand
  
  // Category attributes and inheritance
  attributes        CategoryAttribute[]
  inheritedAttributes CategoryAttributeInheritance[]
  
  // Relationships
  brandCategories   BrandCategory[] // From brand domain
  products          Product[]       // Products in this category
  
  // Audit fields
  createdBy    String
  createdByUser User           @relation("CategoryCreatedBy", fields: [createdBy], references: [id])
  updatedBy    String?
  updatedByUser User?          @relation("CategoryUpdatedBy", fields: [updatedBy], references: [id])
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  // Soft delete
  deletedAt    DateTime?
  deletedBy    String?
  deletedByUser User?          @relation("CategoryDeletedBy", fields: [deletedBy], references: [id])
  
  // Audit trail
  auditLogs    CategoryAuditLog[]
  
  @@map("categories")
  @@index([parentId])
  @@index([path])
  @@index([pathIds])
  @@index([status])
  @@index([visibility])
  @@index([depth])
  @@index([displayOrder])
  @@index([isLeaf])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([slug])
  // Composite indexes for common queries
  @@index([status, visibility])
  @@index([parentId, displayOrder])
  @@index([path, status])
}

model CategoryAttribute {
  id          String           @id @default(cuid())
  categoryId  String
  category    Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Attribute definition
  name        String           // e.g., "Color", "Size", "Material"
  slug        String           // e.g., "color", "size", "material"
  type        AttributeType
  description String?
  
  // Validation rules
  isRequired     Boolean       @default(false)
  isInheritable  Boolean       @default(true)
  isOverridable  Boolean       @default(true)
  isVariant      Boolean       @default(false) // Drives product variants
  isFilterable   Boolean       @default(true)  // Can be used in search filters
  isSearchable   Boolean       @default(false) // Included in search index
  
  // Type-specific configuration
  defaultValue   String?       // Default value for the attribute
  allowedValues  String[]      // For SELECT/MULTI_SELECT types
  validationRules Json?        // Type-specific validation rules
  
  // Display properties
  displayOrder   Int          @default(0)
  displayName    String?      // Human-readable name
  helpText       String?      // Help text for sellers
  placeholder    String?      // Input placeholder
  
  // Inheritance tracking
  inheritedFrom  String?      // Category ID this attribute was inherited from
  overriddenAt   String?      // Category ID where this was overridden
  
  // Audit fields
  createdBy      String
  createdByUser  User         @relation("CategoryAttributeCreatedBy", fields: [createdBy], references: [id])
  updatedBy      String?
  updatedByUser  User?        @relation("CategoryAttributeUpdatedBy", fields: [updatedBy], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  // Relationships
  inheritanceRules CategoryAttributeInheritance[]
  
  @@unique([categoryId, slug])
  @@map("category_attributes")
  @@index([categoryId])
  @@index([type])
  @@index([isRequired])
  @@index([isVariant])
  @@index([isFilterable])
  @@index([displayOrder])
}

// Tracks attribute inheritance relationships
model CategoryAttributeInheritance {
  id                String            @id @default(cuid())
  
  // Source attribute (parent)
  sourceAttributeId String
  sourceAttribute   CategoryAttribute @relation(fields: [sourceAttributeId], references: [id], onDelete: Cascade)
  
  // Target category (child)
  targetCategoryId  String
  targetCategory    Category          @relation(fields: [targetCategoryId], references: [id], onDelete: Cascade)
  
  // Inheritance properties
  isActive          Boolean           @default(true)
  isOverridden      Boolean           @default(false)
  overriddenValues  Json?             // Values that were overridden
  
  // Audit
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@unique([sourceAttributeId, targetCategoryId])
  @@map("category_attribute_inheritance")
  @@index([sourceAttributeId])
  @@index([targetCategoryId])
  @@index([isActive])
}

// Audit log for category changes
model CategoryAuditLog {
  id        String   @id @default(cuid())
  categoryId String
  category  Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  action    String   // CREATE, UPDATE, DELETE, MOVE, ACTIVATE, ARCHIVE, etc.
  oldValues Json?    // Previous values
  newValues Json?    // New values
  changes   Json?    // Specific field changes
  
  // Tree operation specific
  oldPath   String?  // Previous path (for move operations)
  newPath   String?  // New path (for move operations)
  
  // Actor
  userId    String
  user      User     @relation("CategoryAuditUser", fields: [userId], references: [id])
  userRole  String   // Role at time of action
  
  // Context
  ipAddress String?
  userAgent String?
  reason    String?  // Reason for change
  
  createdAt DateTime @default(now())
  
  @@map("category_audit_logs")
  @@index([categoryId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Category tree materialized view for performance (optional)
model CategoryTreeView {
  id            String   @id @default(cuid())
  categoryId    String   @unique
  ancestorId    String
  depth         Int
  path          String
  
  // Cached for performance
  categoryName  String
  categorySlug  String
  categoryStatus CategoryStatus
  
  @@map("category_tree_view")
  @@index([categoryId])
  @@index([ancestorId])
  @@index([depth])
  @@index([path])
}

// Add to existing User model
model User {
  // ... existing fields ...
  
  // Category relationships
  createdCategories     Category[]            @relation("CategoryCreatedBy")
  updatedCategories     Category[]            @relation("CategoryUpdatedBy")
  deletedCategories     Category[]            @relation("CategoryDeletedBy")
  
  // Category attribute relationships
  createdAttributes     CategoryAttribute[]   @relation("CategoryAttributeCreatedBy")
  updatedAttributes     CategoryAttribute[]   @relation("CategoryAttributeUpdatedBy")
  
  // Audit logs
  categoryAuditLogs     CategoryAuditLog[]    @relation("CategoryAuditUser")
}

// Add to existing Product model
model Product {
  // ... existing fields ...
  
  // Category relationship
  categoryId            String?
  category              Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Category path for efficient queries
  categoryPath          String?               // Materialized category path
  categoryPathIds       String[]              // Array of category IDs in path
}